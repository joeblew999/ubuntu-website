# Test workflow for dummy tool round-trip
# Since dummy has CGO=0, we can cross-compile from Linux only
#
# Tests:
#   1. Build xplat (needed by other tasks)
#   2. Build dummy for current platform
#   3. Build dummy for ALL platforms (cross-compile)
#   4. Test install via xplat binary install
#
name: "Test: Dummy Round-Trip"

on:
  workflow_dispatch:
  push:
    paths:
      - 'cmd/dummy/**'
      - 'cmd/xplat/**'
      - 'taskfiles/Taskfile.dummy.yml'
      - 'taskfiles/toolchain/Taskfile.golang.yml'
      - '.github/workflows/test-dummy.yml'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - uses: arduino/setup-task@v2
        with:
          version: 3.x

      # Step 1: Build xplat first (needed by other tasks)
      - name: Build xplat
        run: task tools:xplat:check:deps

      # Step 2: Test dummy:build (local dev build)
      - name: Build dummy (current platform)
        run: task dummy:build

      # Step 3: Test release build for current platform
      - name: Release build (current platform)
        run: task dummy:release:build

      # Step 4: Test built binary
      - name: Test built binary
        run: task dummy:release:test

      # Step 5: Cross-compile for ALL platforms (CGO=0 allows this)
      - name: Cross-compile all platforms
        run: xplat release build dummy

      # Step 6: Verify all binaries were built
      - name: Verify cross-compile output
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-*

          # Check all 6 expected binaries exist
          for BINARY in dummy-linux-amd64 dummy-linux-arm64 dummy-darwin-amd64 dummy-darwin-arm64 dummy-windows-amd64.exe dummy-windows-arm64.exe; do
            if [ ! -f ".build/$BINARY" ]; then
              echo "ERROR: Missing .build/$BINARY"
              exit 1
            fi
          done
          echo "OK: All 6 platform binaries built"

      # Step 7: Clean installed dummy, then test check:deps
      - name: Clean and test check:deps
        run: |
          rm -f ~/.local/bin/dummy
          task dummy:check:deps

      # Step 8: Test dummy:run
      - name: Run dummy
        run: task dummy:run

      # Step 9: Verify version output
      - name: Verify output
        run: |
          OUTPUT=$(task dummy:run 2>&1 | tail -1)
          echo "Output: $OUTPUT"
          if [ "$OUTPUT" != "dev" ]; then
            echo "ERROR: Expected 'dev', got '$OUTPUT'"
            exit 1
          fi
          echo "OK: dummy outputs correct version"
