# Build Codec Static Libraries
#
# This workflow builds x264, libvpx, and opus as static libraries for each
# OS/arch combination using a matrix strategy.
#
# The built libraries are uploaded as release artifacts, which the Go-level
# installer (cmd/codeccheck) can download at runtime.
#
# Triggers:
#   - Manual dispatch (workflow_dispatch)
#   - Release creation
#
name: Build Codec Libraries

permissions:
  contents: write  # Required for creating releases

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'
  release:
    types: [created]

env:
  X264_VERSION: "stable"
  LIBVPX_VERSION: "v1.14.1"
  OPUS_VERSION: "v1.5.2"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            goos: darwin
            goarch: arm64
            nproc_cmd: "sysctl -n hw.ncpu"
            extra_flags: ""
          - os: macos-15-large
            goos: darwin
            goarch: amd64
            nproc_cmd: "sysctl -n hw.ncpu"
            extra_flags: ""
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            nproc_cmd: "nproc"
            extra_flags: "--enable-pic"
          - os: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
            nproc_cmd: "nproc"
            extra_flags: "--enable-pic"

    runs-on: ${{ matrix.os }}
    name: build-${{ matrix.goos }}-${{ matrix.goarch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install build dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install nasm yasm automake autoconf libtool pkg-config

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm automake autoconf libtool pkg-config

      - name: Build x264 static library
        run: |
          git clone --depth 1 --branch ${{ env.X264_VERSION }} https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --enable-static --disable-cli ${{ matrix.extra_flags }} --prefix=$GITHUB_WORKSPACE/out
          make -j$(${{ matrix.nproc_cmd }})
          make install

      - name: Build libvpx static library
        run: |
          git clone --depth 1 --branch ${{ env.LIBVPX_VERSION }} https://chromium.googlesource.com/webm/libvpx
          cd libvpx
          ./configure --enable-static --disable-shared --disable-examples --disable-tools ${{ matrix.extra_flags }} --prefix=$GITHUB_WORKSPACE/out
          make -j$(${{ matrix.nproc_cmd }})
          make install

      - name: Build opus static library
        run: |
          git clone --depth 1 --branch ${{ env.OPUS_VERSION }} https://gitlab.xiph.org/xiph/opus.git
          cd opus
          ./autogen.sh
          PIC_FLAG=""
          if [ -n "${{ matrix.extra_flags }}" ]; then
            PIC_FLAG="--with-pic"
          fi
          ./configure --enable-static --disable-shared $PIC_FLAG --prefix=$GITHUB_WORKSPACE/out
          make -j$(${{ matrix.nproc_cmd }})
          make install

      - name: Package libraries
        run: |
          mkdir -p dist
          tar -czvf dist/codecs-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz -C out .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: codecs-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/codecs-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz

  # ===========================================================================
  # Windows x64 (separate job due to MSYS2 complexity)
  # ===========================================================================
  build-windows:
    runs-on: windows-latest
    name: build-windows-amd64
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            autoconf
            automake
            libtool
            make
            git
            pkg-config

      - name: Set output directory
        id: outdir
        run: |
          OUTDIR=$(cygpath -u "$GITHUB_WORKSPACE")/out
          echo "path=$OUTDIR" >> $GITHUB_OUTPUT
          mkdir -p "$OUTDIR"

      - name: Build x264 static library
        run: |
          git clone --depth 1 --branch ${{ env.X264_VERSION }} https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --enable-static --disable-cli --prefix=${{ steps.outdir.outputs.path }} --host=x86_64-w64-mingw32
          make -j$(nproc)
          make install

      - name: Build libvpx static library
        run: |
          git clone --depth 1 --branch ${{ env.LIBVPX_VERSION }} https://chromium.googlesource.com/webm/libvpx
          cd libvpx
          ./configure --enable-static --disable-shared --disable-examples --disable-tools --target=x86_64-win64-gcc --prefix=${{ steps.outdir.outputs.path }}
          make -j$(nproc)
          make install

      - name: Build opus static library
        run: |
          git clone --depth 1 --branch ${{ env.OPUS_VERSION }} https://gitlab.xiph.org/xiph/opus.git
          cd opus
          ./autogen.sh
          ./configure --enable-static --disable-shared --prefix=${{ steps.outdir.outputs.path }} --host=x86_64-w64-mingw32
          make -j$(nproc)
          make install

      - name: Package libraries
        run: |
          mkdir -p dist
          tar -czvf dist/codecs-windows-amd64.tar.gz -C ${{ steps.outdir.outputs.path }} .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: codecs-windows-amd64
          path: dist/codecs-windows-amd64.tar.gz

  # ===========================================================================
  # Create Release with all artifacts
  # ===========================================================================
  release:
    needs: [build, build-windows]
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'workflow_dispatch' || github.event_name == 'release')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Available artifacts:"
          find artifacts -type f || echo "No artifacts found"

      - name: Check we have at least some artifacts
        run: |
          COUNT=$(find artifacts -name "*.tar.gz" | wc -l)
          echo "Found $COUNT artifact(s)"
          if [ "$COUNT" -eq 0 ]; then
            echo "ERROR: No artifacts were built successfully"
            exit 1
          fi

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*/codecs-*.tar.gz
          fail_on_unmatched_files: false

      - name: Create release from dispatch
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: codecs-${{ github.event.inputs.version }}
          name: Codec Libraries ${{ github.event.inputs.version }}
          body: |
            Pre-built static codec libraries for pion/mediadevices.

            ## Included Libraries
            - x264 (${{ env.X264_VERSION }})
            - libvpx (${{ env.LIBVPX_VERSION }})
            - opus (${{ env.OPUS_VERSION }})

            ## Platforms
            - darwin-arm64 (Apple Silicon)
            - darwin-amd64 (Intel Mac)
            - linux-amd64
            - linux-arm64
            - windows-amd64

            ## Usage
            ```bash
            go run ./cmd/codeccheck -install
            ```

            Or download manually and extract to your lib directory.
          files: artifacts/*/codecs-*.tar.gz
          fail_on_unmatched_files: false
