# Process-Compose Tasks
#
# Local development process orchestration with health checks and auto-restart.
# Now uses xplat's embedded process-compose (xplat process).
#
# Usage:
#   task pc:up              Start all dev processes with TUI dashboard
#   task pc:down            Stop all processes
#   task pc:logs            View combined logs
#   task pc:status          Show process status
#
# Enable optional processes:
#   xplat process up --enable translate
#   xplat process up --enable mailerlite
#
# Documentation: https://github.com/F1bonacc1/process-compose

version: '3'

vars:
  # Use xplat's embedded process-compose
  PC_CMD: '{{.BIN_INSTALL_DIR}}/xplat{{exeExt}} process'

tasks:
  # ===========================================================================
  # Checks (check:* - lifecycle phase)
  # ===========================================================================

  check:deps:
    desc: Ensure xplat is available (process-compose is embedded)
    internal: true
    status:
      - test -f "{{.BIN_INSTALL_DIR}}/xplat{{exeExt}}"
    cmds:
      - task: xplat:check:deps

  # ===========================================================================
  # Core Commands (up/down/logs/status)
  # ===========================================================================

  up:
    desc: Start all dev processes with TUI dashboard
    deps: [check:deps]
    cmds:
      - '{{.PC_CMD}} up'

  up:detached:
    desc: Start dev processes in background (no TUI)
    deps: [check:deps]
    cmds:
      - '{{.PC_CMD}} up -t=false -d'

  down:
    desc: Stop all dev processes
    deps: [check:deps]
    cmds:
      - '{{.PC_CMD}} down'

  logs:
    desc: View combined process logs
    deps: [check:deps]
    cmds:
      - '{{.PC_CMD}} logs'

  status:
    desc: Show process status
    deps: [check:deps]
    cmds:
      - '{{.PC_CMD}} process list'

  # ===========================================================================
  # Process Control
  # ===========================================================================

  restart:
    desc: Restart a specific process (PROCESS=hugo)
    deps: [check:deps]
    requires:
      vars: [PROCESS]
    cmds:
      - '{{.PC_CMD}} process restart {{.PROCESS}}'

  stop:
    desc: Stop a specific process (PROCESS=hugo)
    deps: [check:deps]
    requires:
      vars: [PROCESS]
    cmds:
      - '{{.PC_CMD}} process stop {{.PROCESS}}'

  start:
    desc: Start a specific process (PROCESS=hugo)
    deps: [check:deps]
    requires:
      vars: [PROCESS]
    cmds:
      - '{{.PC_CMD}} process start {{.PROCESS}}'

  # ===========================================================================
  # Process Generation (from package registry)
  # ===========================================================================

  generate:
    desc: Generate process-compose.yaml from package registry
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/xplat{{exeExt}} process-gen generate'

  add:
    desc: Add a package's process to process-compose.yaml (PKG=mailerlite)
    deps: [check:deps]
    requires:
      vars: [PKG]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/xplat{{exeExt}} process-gen add {{.PKG}}'

  remove:
    desc: Remove a package's process from process-compose.yaml (PKG=mailerlite)
    deps: [check:deps]
    requires:
      vars: [PKG]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/xplat{{exeExt}} process-gen remove {{.PKG}}'

  list:packages:
    desc: List packages with process configurations
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/xplat{{exeExt}} process-gen list'
