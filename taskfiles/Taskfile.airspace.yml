# Airspace Pipeline - FAA data sync and tile generation
#
# All logic is in Go: cmd/airspace/main.go
# All file paths are constants in the Go code.
#
# Usage:
#   task airspace:pipeline   - Full idempotent pipeline (sync → tile → manifest)
#   task airspace:status     - Show current data status

version: '3'

tasks:
  # Primary commands - everything else is in Go
  pipeline:
    desc: Full idempotent pipeline (sync → tile → manifest)
    cmds:
      - go run ./cmd/airspace pipeline

  pipeline:force:
    desc: Force full pipeline even if no changes
    cmds:
      - go run ./cmd/airspace pipeline -force

  # Pure Go pipeline (no external dependencies)
  pipeline:go:
    desc: Full pipeline using pure Go tiler (no tippecanoe needed)
    cmds:
      - go run ./cmd/airspace pipeline -tiler gotiler

  pipeline:go:force:
    desc: Force pipeline with pure Go tiler
    cmds:
      - go run ./cmd/airspace pipeline -tiler gotiler -force

  pipeline:go:upload:
    desc: Pure Go pipeline + R2 upload
    cmds:
      - go run ./cmd/airspace pipeline -tiler gotiler
      - |
        if [ -f "data/airspace/sync_result.json" ]; then
          HAS_CHANGES=$(jq -r '.has_changes' data/airspace/sync_result.json)
          if [ "$HAS_CHANGES" = "true" ]; then
            echo "Uploading to R2..."
            task r2:airspace:upload
          else
            echo "No changes - skipping R2 upload"
          fi
        fi

  pipeline:upload:
    desc: Pipeline + R2 upload (idempotent)
    cmds:
      - go run ./cmd/airspace pipeline
      - |
        if [ -f "data/airspace/sync_result.json" ]; then
          HAS_CHANGES=$(jq -r '.has_changes' data/airspace/sync_result.json)
          if [ "$HAS_CHANGES" = "true" ]; then
            echo "Uploading to R2..."
            task r2:airspace:upload
          else
            echo "No changes - skipping R2 upload"
          fi
        fi

  # Individual commands (for debugging/manual use)
  sync:
    desc: Sync FAA data (ETag-based change detection)
    cmds:
      - go run ./cmd/airspace sync

  tile:
    desc: Convert GeoJSON to PMTiles (auto-detect tiler)
    cmds:
      - go run ./cmd/airspace tile

  tile:go:
    desc: Convert GeoJSON to PMTiles using pure Go (no tippecanoe)
    cmds:
      - go run ./cmd/airspace tile -tiler gotiler

  manifest:
    desc: Generate manifest files
    cmds:
      - go run ./cmd/airspace manifest

  status:
    desc: Show data file status
    cmds:
      - go run ./cmd/airspace status

  history:
    desc: Show sync history (for cron tuning)
    cmds:
      - go run ./cmd/airspace history

  check:
    desc: Check if sync had changes (for CI)
    cmds:
      - go run ./cmd/airspace check

  summary:
    desc: Generate markdown summary (for CI)
    cmds:
      - go run ./cmd/airspace summary

  # Tool installation
  install:
    desc: Install tippecanoe
    status:
      - which tippecanoe
    cmds:
      - |
        case "$(uname)" in
          Darwin) brew install tippecanoe ;;
          Linux) sudo apt-get update && sudo apt-get install -y tippecanoe ;;
        esac

  # Demo
  open:
    desc: Open airspace demo in browser
    cmds:
      - open http://localhost:1313/fleet/airspace-demo/
