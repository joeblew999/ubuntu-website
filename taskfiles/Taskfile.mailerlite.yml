# MailerLite Tasks
#
# CLI tool for MailerLite subscriber management.
#
# Usage:
#   task mailerlite:check                             - Run all verification checks
#   task mailerlite:subscribers:list                  - List all subscribers
#   task mailerlite:subscribers:count                 - Count total subscribers
#   task mailerlite:subscribers:add EMAIL=x@y.com     - Add subscriber
#   task mailerlite:subscribers:delete EMAIL=x@y.com  - Delete subscriber
#   task mailerlite:groups:list                       - List all groups
#   task mailerlite:groups:create NAME="My Group"     - Create a group
#   task mailerlite:groups:assign GROUP_ID=x EMAIL=y  - Assign subscriber to group
#   task mailerlite:forms:list                        - List all forms
#   task mailerlite:webhooks:list                     - List all webhooks
#   task mailerlite:webhooks:create URL=x             - Create a webhook
#   task mailerlite:automations:list                  - List all automations
#   task mailerlite:stats                             - Show account statistics
#   task mailerlite:open [TARGET=dashboard]           - Open dashboard in browser
#   task mailerlite:releases:latest                   - Show latest GitHub release
#   task mailerlite:releases:list                     - List all GitHub releases
#   task mailerlite:releases:urls                     - Show download URLs for emails
#
# Environment:
#   MAILERLITE_API_KEY    API key (required, from .env)
#
# Get API key from: https://dashboard.mailerlite.com/integrations/api

version: '3'

vars:
  MAILERLITE_BIN: 'mailerlite{{exeExt}}'
  MAILERLITE_CMD: '{{.BIN_INSTALL_DIR}}/{{.MAILERLITE_BIN}}'

tasks:
  # ===========================================================================
  # Checks (check:* - lifecycle phase)
  # ===========================================================================

  check:
    desc: Run all verification checks (API connection, groups, webhooks)
    deps: [check:deps]
    cmds:
      - |
        echo "╔══════════════════════════════════════════════════════════════╗"
        echo "║         MailerLite Verification                              ║"
        echo "╚══════════════════════════════════════════════════════════════╝"
        echo ""
      - '{{.MAILERLITE_CMD}} stats'
      - echo ""
      - '{{.MAILERLITE_CMD}} groups list'
      - echo ""
      - '{{.MAILERLITE_CMD}} webhooks list'
      - echo ""
      - '{{.MAILERLITE_CMD}} releases latest'

  check:deps:
    desc: Ensure mailerlite binary is available (builds from source or downloads)
    internal: true
    status:
      - test -f "{{.BIN_INSTALL_DIR}}/{{.MAILERLITE_BIN}}"
    cmds:
      - mkdir -p "{{.BIN_INSTALL_DIR}}"
      - go build -o "{{.BIN_INSTALL_DIR}}/{{.MAILERLITE_BIN}}" ./cmd/mailerlite

  # ===========================================================================
  # Subscribers (subscribers:* - subscriber management)
  # ===========================================================================

  subscribers:list:
    desc: List all subscribers
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} subscribers list'

  subscribers:count:
    desc: Count total subscribers
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} subscribers count'

  subscribers:get:
    desc: Get subscriber by email (EMAIL=user@example.com)
    deps: [check:deps]
    requires:
      vars: [EMAIL]
    cmds:
      - '{{.MAILERLITE_CMD}} subscribers get {{.EMAIL}}'

  subscribers:add:
    desc: Add or update subscriber (EMAIL=user@example.com, NAME="John Doe" optional)
    deps: [check:deps]
    requires:
      vars: [EMAIL]
    cmds:
      - '{{.MAILERLITE_CMD}} subscribers add {{.EMAIL}} {{.NAME | default ""}}'

  subscribers:delete:
    desc: Delete subscriber (EMAIL=user@example.com)
    deps: [check:deps]
    requires:
      vars: [EMAIL]
    cmds:
      - '{{.MAILERLITE_CMD}} subscribers delete {{.EMAIL}}'

  # ===========================================================================
  # Groups (groups:* - group management)
  # ===========================================================================

  groups:list:
    desc: List all groups
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} groups list'

  groups:create:
    desc: Create a new group (NAME="Newsletter Subscribers")
    deps: [check:deps]
    requires:
      vars: [NAME]
    cmds:
      - '{{.MAILERLITE_CMD}} groups create {{.NAME}}'

  groups:subscribers:
    desc: List subscribers in a group (GROUP_ID=xxx)
    deps: [check:deps]
    requires:
      vars: [GROUP_ID]
    cmds:
      - '{{.MAILERLITE_CMD}} groups subscribers {{.GROUP_ID}}'

  groups:assign:
    desc: Assign subscriber to group (GROUP_ID=xxx EMAIL=user@example.com)
    deps: [check:deps]
    requires:
      vars: [GROUP_ID, EMAIL]
    cmds:
      - '{{.MAILERLITE_CMD}} groups assign {{.GROUP_ID}} {{.EMAIL}}'

  groups:unassign:
    desc: Remove subscriber from group (GROUP_ID=xxx EMAIL=user@example.com)
    deps: [check:deps]
    requires:
      vars: [GROUP_ID, EMAIL]
    cmds:
      - '{{.MAILERLITE_CMD}} groups unassign {{.GROUP_ID}} {{.EMAIL}}'

  # ===========================================================================
  # Forms (forms:* - form management)
  # ===========================================================================

  forms:list:
    desc: List all forms
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} forms list'

  forms:subscribers:
    desc: List subscribers for a form (FORM_ID=xxx)
    deps: [check:deps]
    requires:
      vars: [FORM_ID]
    cmds:
      - '{{.MAILERLITE_CMD}} forms subscribers {{.FORM_ID}}'

  # ===========================================================================
  # Webhooks (webhooks:* - webhook management)
  # ===========================================================================

  webhooks:list:
    desc: List all webhooks
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} webhooks list'

  webhooks:create:
    desc: Create a webhook (URL=https://... EVENTS="subscriber.created" optional)
    summary: |
      Create a webhook to receive notifications when events occur.

      Events (space-separated):
        subscriber.created, subscriber.updated, subscriber.unsubscribed
        subscriber.added_to_group, subscriber.removed_from_group
        subscriber.bounced, subscriber.automation_triggered
        campaign.sent, campaign.opened, campaign.clicked

      Example:
        task mailerlite:webhooks:create URL=https://example.com/webhook
        task mailerlite:webhooks:create URL=https://example.com/webhook EVENTS="subscriber.created subscriber.updated"
    deps: [check:deps]
    requires:
      vars: [URL]
    cmds:
      - '{{.MAILERLITE_CMD}} webhooks create {{.URL}} {{.EVENTS | default "subscriber.created"}}'

  webhooks:delete:
    desc: Delete a webhook (WEBHOOK_ID=xxx)
    deps: [check:deps]
    requires:
      vars: [WEBHOOK_ID]
    cmds:
      - '{{.MAILERLITE_CMD}} webhooks delete {{.WEBHOOK_ID}}'

  # ===========================================================================
  # Automations (automations:* - automation management)
  # ===========================================================================

  automations:list:
    desc: List all automations
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} automations list'

  automations:get:
    desc: Get automation details (AUTOMATION_ID=xxx)
    deps: [check:deps]
    requires:
      vars: [AUTOMATION_ID]
    cmds:
      - '{{.MAILERLITE_CMD}} automations get {{.AUTOMATION_ID}}'

  # ===========================================================================
  # Statistics (stats - account overview)
  # ===========================================================================

  stats:
    desc: Show account statistics
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} stats'

  # ===========================================================================
  # Open (open - browser shortcuts)
  # ===========================================================================

  open:
    desc: Open MailerLite dashboard in browser (TARGET=dashboard|subscribers|groups|forms|automations|webhooks|api)
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} open {{.TARGET | default "dashboard"}}'
    vars:
      TARGET: '{{.TARGET | default "dashboard"}}'

  # ===========================================================================
  # Releases (releases:* - GitHub release info)
  # ===========================================================================

  releases:latest:
    desc: Show latest GitHub release with download URLs
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} releases latest'

  releases:list:
    desc: List all GitHub releases
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} releases list'

  releases:urls:
    desc: Show download URLs formatted for email templates
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} releases urls'

  # ===========================================================================
  # Server (server:* - webhook receiver)
  # ===========================================================================

  server:
    desc: Start webhook server to receive Web3Forms submissions
    summary: |
      Starts an HTTP server that receives webhook POSTs from Web3Forms
      and adds subscribers to MailerLite.

      Variables:
        PORT     - Server port (default: 8086)
        GROUP_ID - Optional group ID to auto-assign subscribers

      Endpoints:
        POST /webhook - Receive Web3Forms submission
        GET  /health  - Health check

      For production use with a tunnel:
        ngrok http 8086
        cloudflared tunnel --url http://localhost:8086
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} server PORT={{.PORT}} {{if .GROUP_ID}}GROUP_ID={{.GROUP_ID}}{{end}}'
    vars:
      PORT: '{{.PORT | default "8086"}}'
      GROUP_ID: '{{.GROUP_ID | default ""}}'

  # ===========================================================================
  # CI Tasks (ci:* - for GitHub Actions)
  # ===========================================================================

  ci:report:
    desc: '[Monitor] Generate subscriber report (markdown output)'
    deps: [check:deps]
    cmds:
      - '{{.MAILERLITE_CMD}} -github-issue stats'

  # ===========================================================================
  # Release (release:* - build for distribution)
  # ===========================================================================

  release:build:
    desc: Build mailerlite for release (current platform, or set GOOS/GOARCH)
    cmds:
      - mkdir -p "{{.ROOT_DIR}}/{{.DIR_BUILD}}"
      - go build -o "{{.ROOT_DIR}}/{{.DIR_BUILD}}/{{.MAILERLITE_BIN}}" ./cmd/mailerlite

  release:test:
    desc: Test built mailerlite release binary
    cmds:
      - "{{.ROOT_DIR}}/{{.DIR_BUILD}}/{{.MAILERLITE_BIN}} -h || true"
