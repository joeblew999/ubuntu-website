# Translation Tasks
#
# Workflow for managing multilingual content translations.
# Uses git tags to track translation checkpoints.
#
# Configuration:
#   - Hugo projects: Languages auto-loaded from config/_default/languages.toml
#   - Standalone: Uses defaults (de, zh, ja) - edit internal/translator/translator.go
#
# Workflow:
#   1. task translate:status    - see what source files changed since last translation
#   2. task translate:missing   - see which files don't exist in target languages
#   3. task translate:next      - show next file to translate (with progress)
#   4. task translate:stale     - find existing translations that may be outdated
#   5. task translate:diff FILE=path  - show what changed in a specific source file
#   6. Ask Claude Code: "Translate X to all languages"
#   7. task translate:done      - mark translations complete
#
# Validation:
#   - task translate:orphans    - find target files with no source (delete these)
#   - task translate:clean      - auto-delete orphaned files
#   - task translate:validate   - show current config (Hugo or standalone)

version: '3'

vars:
  TRANSLATE_REPO: joeblew999/ubuntu-website
  TRANSLATE_BIN: 'translate{{exeExt}}'

tasks:
  # ===========================================================================
  # Dependency Management
  # ===========================================================================

  check:deps:
    desc: Ensure translate binary is available (builds from source or downloads)
    status:
      - test -f "{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}}"
    cmds:
      - '{{.XPLAT_BIN}} binary install translate {{.TRANSLATE_VERSION}} {{.TRANSLATE_REPO}} --source "{{toSlash .ROOT_DIR}}/cmd/translate"'

  # ===========================================================================
  # Status Commands
  # ===========================================================================

  status:
    desc: Show what English files changed since last translation
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} status'

  done:
    desc: Mark current translations as complete (update checkpoint tag)
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} done'

  diff:
    desc: Show git diff for a specific English file since last translation
    deps: [check:deps]
    vars:
      FILE: '{{.FILE | default ""}}'
    cmds:
      - |
        FILE="{{.FILE}}"
        if [ -z "$FILE" ]; then
          echo "========================================"
          echo "Usage: task translate:diff FILE=blog/my-post.md"
          echo ""
          echo "Shows what changed in an English file since last translation."
          echo "The FILE path is relative to content/english/"
          echo "========================================"
          exit 1
        fi
        {{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} diff "$FILE"

  changed:
    desc: Show detailed changes for all English files since last translation
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} changed'

  # ===========================================================================
  # Validation Commands
  # ===========================================================================

  missing:
    desc: Show which languages are missing content files compared to English
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} missing'

  orphans:
    desc: Show files in target languages that no longer exist in English (should be deleted)
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} orphans'

  next:
    desc: Show the next file to translate (first missing file)
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} next'

  stale:
    desc: Show target files that are smaller than English (may need updating)
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} stale'

  clean:
    desc: Delete orphaned files in target languages that no longer exist in English
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} clean'

  validate:
    desc: Show current language configuration (auto-detected from Hugo or defaults)
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} validate'

  langs:
    desc: Show configured languages and detect stray content directories
    deps: [check:deps]
    cmds:
      - '{{.BIN_INSTALL_DIR}}/{{.TRANSLATE_BIN}} langs'
