{{/* Airspace Demo - Full-screen interactive map */}}
{{/* Uses PMTiles from R2 for efficient progressive loading */}}
{{/* Configuration: data/airspace/datasets.json is the single source of truth */}}
{{/* Layer names and filenames here MUST match that file */}}

{{ define "main" }}
<style>
    /* Override theme styles for full-screen map */
    main { padding: 0 !important; margin: 0 !important; max-width: 100% !important; }
    .container { max-width: 100% !important; padding: 0 !important; }

    #airspace-map { height: calc(100vh - 80px); width: 100%; }
    .info-panel {
        position: absolute;
        top: 90px;
        right: 10px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        max-width: 300px;
        transition: transform 0.3s ease;
    }
    .info-panel h2 {
        font-size: 14px;
        margin-bottom: 10px;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .panel-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 0 5px;
    }
    .legend { font-size: 12px; }
    .legend-item { display: flex; align-items: center; margin: 5px 0; }
    .legend-color { width: 20px; height: 14px; margin-right: 8px; border: 1px solid #666; }
    .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px 40px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        z-index: 2000;
        font-size: 14px;
    }
    .layer-toggle { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
    .layer-toggle label { display: flex; align-items: center; margin: 5px 0; font-size: 12px; cursor: pointer; }
    .layer-toggle input { margin-right: 8px; }
    .data-mode { font-size: 10px; color: #666; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
    .panel-content { transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; }

    /* Mobile styles */
    @media (max-width: 600px) {
        .info-panel {
            top: auto;
            bottom: 10px;
            left: 10px;
            right: 10px;
            max-width: none;
            padding: 10px;
        }
        .info-panel h2 { margin-bottom: 5px; }
        .panel-toggle { display: block; }
        .legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 10px;
        }
        .legend-item { margin: 2px 0; font-size: 11px; }
        .legend-color { width: 16px; height: 12px; margin-right: 5px; }
        .layer-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 10px;
            margin-top: 10px;
            padding-top: 8px;
        }
        .layer-toggle label { margin: 2px 0; font-size: 11px; }
        .data-mode { margin-top: 8px; padding-top: 8px; }

        /* Collapsed state */
        .info-panel.collapsed .panel-content {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        .info-panel.collapsed { padding: 10px; }
        .info-panel.collapsed h2 { margin-bottom: 0; }
    }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div style="position: relative;">
    <div id="airspace-map"></div>
    <div id="loading" class="loading-overlay">Loading airspace data...</div>

    <div class="info-panel" id="info-panel">
        <h2><span>US Airspace Viewer</span><button class="panel-toggle" id="panel-toggle" aria-label="Toggle panel">â–¼</button></h2>
        <div class="panel-content">
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #0066cc;"></div> Class B</div>
                <div class="legend-item"><div class="legend-color" style="background: #cc00cc;"></div> Class C</div>
                <div class="legend-item"><div class="legend-color" style="background: #0099cc;"></div> Class D</div>
                <div class="legend-item"><div class="legend-color" style="background: #00cc99;"></div> Class E</div>
                <div class="legend-item"><div class="legend-color" style="background: #cc0000;"></div> Restricted</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff9900;"></div> MOA</div>
                <div class="legend-item" id="laanc-legend" style="display:none;"><div class="legend-color" style="background: rgba(255,255,0,0.5);"></div> LAANC</div>
                <div class="legend-item"><div class="legend-color" style="background: #00ff00; border-radius: 50%;"></div> Airports</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff00ff; border-radius: 50%;"></div> Navaids</div>
            </div>
            <div class="layer-toggle">
                <label><input type="checkbox" id="toggle-boundary" checked> Boundaries</label>
                <label><input type="checkbox" id="toggle-sua" checked> Special Use</label>
                <label id="laanc-toggle-label" style="display:none;"><input type="checkbox" id="toggle-laanc"> LAANC</label>
                <label><input type="checkbox" id="toggle-airports"> Airports</label>
                <label><input type="checkbox" id="toggle-navaids"> Navaids</label>
            </div>
            <div class="data-mode" id="data-mode">Loading...</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>
<script src="https://unpkg.com/protomaps-leaflet@5.1.0/dist/protomaps-leaflet.js"></script>
<script>
    // Data URL - local for dev, R2 for production
    const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const DATA_BASE = isLocalDev ? '/airspace' : '{{ site.Params.r2.public_url }}/airspace';
    const TILES_BASE = DATA_BASE + '/tiles';

    console.log('Airspace Demo:', isLocalDev ? 'LOCAL mode' : 'R2 mode', '- Data from:', DATA_BASE);

    // Initialize map centered on continental US
    const map = L.map('airspace-map').setView([39.8, -98.5], 5);

    // Add base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap | Airspace data: FAA'
    }).addTo(map);

    // Track layers and loading mode
    let usePMTiles = false;
    let boundaryLayer = null;
    let suaLayer = null;
    let laancLayer = null;
    let airportsLayer = null;
    let navaidsLayer = null;

    // PMTiles style rules for airspace classes
    // Note: Boundary data uses CLASS (A/C/D/E/G) and TYPE_CODE (CTA, TMA, SATA, etc.)
    const boundaryRules = [
        // Class A (high altitude controlled)
        { dataLayer: 'boundary', filter: (z, f) => f.props.CLASS === 'A',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#0066cc', opacity: 0.15, stroke: '#0066cc', width: 1 }) },
        // Class C (terminal areas)
        { dataLayer: 'boundary', filter: (z, f) => f.props.CLASS === 'C',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#cc00cc', opacity: 0.2, stroke: '#cc00cc', width: 2 }) },
        // Class D (smaller towered)
        { dataLayer: 'boundary', filter: (z, f) => f.props.CLASS === 'D',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#0099cc', opacity: 0.15, stroke: '#0099cc', width: 2 }) },
        // Class E (controlled airspace)
        { dataLayer: 'boundary', filter: (z, f) => f.props.CLASS === 'E',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#00cc99', opacity: 0.1, stroke: '#00cc99', width: 1 }) },
        // Class G (uncontrolled)
        { dataLayer: 'boundary', filter: (z, f) => f.props.CLASS === 'G',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#999999', opacity: 0.05, stroke: '#999999', width: 1 }) },
        // Fallback for all other boundary features (null CLASS, TYPE_CODE based)
        { dataLayer: 'boundary',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#666666', opacity: 0.1, stroke: '#666666', width: 1 }) },
    ];

    // SUA uses TYPE_CODE: R (Restricted), P (Prohibited), MOA, A (Alert), W (Warning), D
    const suaRules = [
        { dataLayer: 'sua', filter: (z, f) => f.props.TYPE_CODE === 'R',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#cc0000', opacity: 0.3, stroke: '#cc0000', width: 2 }) },
        { dataLayer: 'sua', filter: (z, f) => f.props.TYPE_CODE === 'P',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#ff0000', opacity: 0.4, stroke: '#ff0000', width: 2 }) },
        { dataLayer: 'sua', filter: (z, f) => f.props.TYPE_CODE === 'MOA',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#ff9900', opacity: 0.2, stroke: '#ff9900', width: 1 }) },
        { dataLayer: 'sua', filter: (z, f) => f.props.TYPE_CODE === 'A',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#ffcc00', opacity: 0.2, stroke: '#ffcc00', width: 1 }) },
        { dataLayer: 'sua', filter: (z, f) => f.props.TYPE_CODE === 'W',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#996600', opacity: 0.15, stroke: '#996600', width: 1 }) },
        { dataLayer: 'sua',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#666666', opacity: 0.1, stroke: '#666666', width: 1 }) },
    ];

    const airportsRules = [
        { dataLayer: 'airports',
          symbolizer: new protomapsL.CircleSymbolizer({ fill: '#00ff00', stroke: '#006600', width: 1, radius: 5 }) },
    ];

    const navaidsRules = [
        { dataLayer: 'navaids',
          symbolizer: new protomapsL.CircleSymbolizer({ fill: '#ff00ff', stroke: '#660066', width: 1, radius: 4 }) },
    ];

    const laancRules = [
        { dataLayer: 'uas',
          symbolizer: new protomapsL.PolygonSymbolizer({ fill: '#ffff00', opacity: 0.5, stroke: '#cc9900', width: 1 }) },
    ];

    // Check data availability: individual PMTiles (best for filtering) > GeoJSON fallback
    // Note: Combined PMTiles removed - doesn't support per-layer filtering
    async function checkDataMode() {
        try {
            // Check individual PMTiles (allows per-layer toggling)
            const boundaryResp = await fetch(`${TILES_BASE}/faa_airspace_boundary.pmtiles`, { method: 'HEAD' });
            if (boundaryResp.ok) return 'individual';

            // Fallback to GeoJSON
            return 'geojson';
        } catch (e) {
            return 'geojson';
        }
    }

    // Load individual PMTiles (separate files per layer - supports filtering)
    async function loadIndividualPMTiles() {
        console.log('Loading individual PMTiles from:', TILES_BASE);

        // Boundary layer
        boundaryLayer = protomapsL.leafletLayer({
            url: `${TILES_BASE}/faa_airspace_boundary.pmtiles`,
            paintRules: boundaryRules,
        });
        boundaryLayer.addTo(map);

        // SUA layer
        suaLayer = protomapsL.leafletLayer({
            url: `${TILES_BASE}/faa_special_use_airspace.pmtiles`,
            paintRules: suaRules,
        });
        suaLayer.addTo(map);

        // Airports layer (not shown by default)
        airportsLayer = protomapsL.leafletLayer({
            url: `${TILES_BASE}/faa_airports.pmtiles`,
            paintRules: airportsRules,
        });

        // Navaids layer (not shown by default)
        navaidsLayer = protomapsL.leafletLayer({
            url: `${TILES_BASE}/faa_navaids.pmtiles`,
            paintRules: navaidsRules,
        });

        // LAANC layer (not shown by default)
        laancLayer = protomapsL.leafletLayer({
            url: `${TILES_BASE}/faa_uas_facility_map.pmtiles`,
            paintRules: laancRules,
        });

        // Show LAANC toggle in PMTiles mode
        document.getElementById('laanc-toggle-label').style.display = 'flex';
        document.getElementById('laanc-legend').style.display = 'flex';

        document.getElementById('loading').style.display = 'none';
        document.getElementById('data-mode').textContent = 'âš¡ PMTiles (per-layer files)';
    }

    // GeoJSON fallback functions
    function getAirspaceStyle(feature) {
        const props = feature.properties;
        const classType = props.CLASS || props.TYPE_CODE || '';
        const styles = {
            'B': { color: '#0066cc', fillColor: '#0066cc', weight: 2, fillOpacity: 0.2 },
            'C': { color: '#cc00cc', fillColor: '#cc00cc', weight: 2, fillOpacity: 0.2 },
            'D': { color: '#0099cc', fillColor: '#0099cc', weight: 2, fillOpacity: 0.15 },
            'E': { color: '#00cc99', fillColor: '#00cc99', weight: 1, fillOpacity: 0.1 },
            'E2': { color: '#00cc99', fillColor: '#00cc99', weight: 1, fillOpacity: 0.1 },
            'E3': { color: '#00cc99', fillColor: '#00cc99', weight: 1, fillOpacity: 0.1 },
            'E4': { color: '#00cc99', fillColor: '#00cc99', weight: 1, fillOpacity: 0.1 },
        };
        return styles[classType] || { color: '#666', fillColor: '#666', weight: 1, fillOpacity: 0.1 };
    }

    function getSUAStyle(feature) {
        const typeCode = feature.properties.TYPE_CODE || '';
        if (typeCode === 'R' || typeCode === 'P') {
            return { color: '#cc0000', fillColor: '#cc0000', weight: 2, fillOpacity: 0.3 };
        }
        if (typeCode === 'M' || typeCode === 'MOA') {
            return { color: '#ff9900', fillColor: '#ff9900', weight: 1, fillOpacity: 0.2 };
        }
        if (typeCode === 'A' || typeCode === 'W') {
            return { color: '#996600', fillColor: '#996600', weight: 1, fillOpacity: 0.15 };
        }
        return { color: '#666', fillColor: '#666', weight: 1, fillOpacity: 0.1 };
    }

    function getLAANCStyle(feature) {
        const ceiling = feature.properties.CEILING || 0;
        const opacity = Math.min(0.1 + (ceiling / 400) * 0.3, 0.4);
        return { color: '#ffcc00', fillColor: '#ffff00', weight: 0.5, fillOpacity: opacity };
    }

    function onEachFeature(feature, layer) {
        const props = feature.properties;
        let content = '<div style="font-size:12px;">';
        if (props.NAME) content += `<b>${props.NAME}</b><br>`;
        if (props.CLASS) content += `Class: ${props.CLASS}<br>`;
        if (props.TYPE_CODE) content += `Type: ${props.TYPE_CODE}<br>`;
        if (props.CEILING) content += `LAANC Ceiling: ${props.CEILING} ft<br>`;
        if (props.APT1_NAME) content += `Airport: ${props.APT1_NAME} (${props.APT1_ICAO})<br>`;
        if (props.UPPER_VAL) content += `Upper: ${props.UPPER_VAL} ${props.UPPER_UOM || 'ft'}<br>`;
        if (props.LOWER_VAL) content += `Lower: ${props.LOWER_VAL} ${props.LOWER_UOM || 'ft'}<br>`;
        content += '</div>';
        layer.bindPopup(content);
    }

    // Load GeoJSON fallback
    async function loadGeoJSON() {
        console.log('Loading GeoJSON from:', DATA_BASE);

        // Create layer groups
        boundaryLayer = L.layerGroup().addTo(map);
        suaLayer = L.layerGroup().addTo(map);
        laancLayer = L.layerGroup();
        airportsLayer = L.layerGroup();
        navaidsLayer = L.layerGroup();

        try {
            // Load airspace boundaries
            const boundaryResp = await fetch(`${DATA_BASE}/faa_airspace_boundary.geojson`);
            const boundaryData = await boundaryResp.json();
            L.geoJSON(boundaryData, { style: getAirspaceStyle, onEachFeature }).addTo(boundaryLayer);

            // Load Special Use Airspace
            const suaResp = await fetch(`${DATA_BASE}/faa_special_use_airspace.geojson`);
            const suaData = await suaResp.json();
            L.geoJSON(suaData, { style: getSUAStyle, onEachFeature }).addTo(suaLayer);

            // Load LAANC grid
            const laancResp = await fetch(`${DATA_BASE}/faa_uas_facility_map.geojson`);
            const laancData = await laancResp.json();
            L.geoJSON(laancData, { style: getLAANCStyle, onEachFeature }).addTo(laancLayer);

            // Load Airports
            const airportsResp = await fetch(`${DATA_BASE}/faa_airports.geojson`);
            const airportsData = await airportsResp.json();
            L.geoJSON(airportsData, {
                pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
                    radius: 5, fillColor: '#00ff00', color: '#006600', weight: 1, opacity: 1, fillOpacity: 0.8
                }),
                onEachFeature: (feature, layer) => {
                    const props = feature.properties;
                    let content = '<div style="font-size:12px;">';
                    if (props.SITE_NO) content += `<b>${props.SITE_NO}</b><br>`;
                    if (props.CITY) content += `City: ${props.CITY}<br>`;
                    if (props.STATE_NAME) content += `State: ${props.STATE_NAME}<br>`;
                    if (props.OWNER_TYPE) content += `Type: ${props.OWNER_TYPE}<br>`;
                    content += '</div>';
                    layer.bindPopup(content);
                }
            }).addTo(airportsLayer);

            // Load Navigation Aids
            const navaidsResp = await fetch(`${DATA_BASE}/faa_navaids.geojson`);
            const navaidsData = await navaidsResp.json();
            L.geoJSON(navaidsData, {
                pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
                    radius: 4, fillColor: '#ff00ff', color: '#660066', weight: 1, opacity: 1, fillOpacity: 0.8
                }),
                onEachFeature: (feature, layer) => {
                    const props = feature.properties;
                    let content = '<div style="font-size:12px;">';
                    if (props.NAVAID_ID) content += `<b>${props.NAVAID_ID}</b><br>`;
                    if (props.NAVAID_NAME) content += `Name: ${props.NAVAID_NAME}<br>`;
                    if (props.NAVAID_TYPE) content += `Type: ${props.NAVAID_TYPE}<br>`;
                    if (props.CITY) content += `City: ${props.CITY}<br>`;
                    content += '</div>';
                    layer.bindPopup(content);
                }
            }).addTo(navaidsLayer);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('data-mode').textContent = 'ðŸ“¦ GeoJSON (full download)';
        } catch (err) {
            document.getElementById('loading').textContent = 'Error loading data: ' + err.message;
        }
    }

    // Layer toggles
    function setupToggles() {
        document.getElementById('toggle-boundary').addEventListener('change', (e) => {
            if (boundaryLayer) {
                e.target.checked ? map.addLayer(boundaryLayer) : map.removeLayer(boundaryLayer);
            }
        });
        document.getElementById('toggle-sua').addEventListener('change', (e) => {
            if (suaLayer) {
                e.target.checked ? map.addLayer(suaLayer) : map.removeLayer(suaLayer);
            }
        });
        document.getElementById('toggle-laanc').addEventListener('change', (e) => {
            if (laancLayer) {
                e.target.checked ? map.addLayer(laancLayer) : map.removeLayer(laancLayer);
            }
        });
        document.getElementById('toggle-airports').addEventListener('change', (e) => {
            if (airportsLayer) {
                e.target.checked ? map.addLayer(airportsLayer) : map.removeLayer(airportsLayer);
            }
        });
        document.getElementById('toggle-navaids').addEventListener('change', (e) => {
            if (navaidsLayer) {
                e.target.checked ? map.addLayer(navaidsLayer) : map.removeLayer(navaidsLayer);
            }
        });
    }

    // Mobile panel toggle
    function setupPanelToggle() {
        const panel = document.getElementById('info-panel');
        const toggle = document.getElementById('panel-toggle');
        toggle.addEventListener('click', () => {
            panel.classList.toggle('collapsed');
            toggle.textContent = panel.classList.contains('collapsed') ? 'â–²' : 'â–¼';
        });
    }

    // Initialize
    async function init() {
        setupToggles();
        setupPanelToggle();

        // Check data availability: individual PMTiles (with filtering) > GeoJSON fallback
        const dataMode = await checkDataMode();

        if (dataMode === 'individual') {
            await loadIndividualPMTiles();
        } else {
            await loadGeoJSON();
            // Show LAANC toggle in GeoJSON mode (also shown in PMTiles mode via loadIndividualPMTiles)
            document.getElementById('laanc-toggle-label').style.display = 'flex';
            document.getElementById('laanc-legend').style.display = 'flex';
        }
    }

    init();
</script>
{{ end }}
