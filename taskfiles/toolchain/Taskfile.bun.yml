# Bun Runtime Tasks
#
# Cross-platform Bun installation and validation.
# Works on macOS, Linux, Windows.
#
# Version Management:
#   - BUN_VERSION from versions.env (loaded by root Taskfile dotenv)
#
# Pattern: All tool taskfiles define TOOL_BIN with {{exeExt}} for Windows support
#
# Other modules that need Bun should:
#   1. Add `# REQUIRES: bun` to their header
#   2. Call `task: :bun:check:deps` before using Bun

version: '3'

# REQUIRES: none

vars:
  # BUN_VERSION comes from versions.env (loaded by root Taskfile dotenv)
  BUN_BIN: 'bun{{exeExt}}'

tasks:
  # ===========================================================================
  # Checks (check:* - diagnostics for this module)
  # ===========================================================================

  check:deps:
    desc: Ensure Bun is installed
    run: once
    cmds:
      - |
        # BUN_VERSION comes from versions.env (loaded by root Taskfile dotenv)
        EXPECTED="${BUN_VERSION:-1.3}"

        # Check if bun exists
        if ! command -v bun >/dev/null 2>&1; then
          # Detect CI environment
          if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ]; then
            echo "ERROR: Bun is not installed"
            echo ""
            echo "Add to your workflow before running tasks:"
            echo ""
            echo "    - name: Setup Bun"
            echo "      uses: oven-sh/setup-bun@v2"
            echo "      with:"
            echo "        bun-version: '$EXPECTED'"
            echo ""
            exit 1
          fi

          # Local: provide install instructions
          echo "ERROR: Bun not found in PATH"
          echo ""
          echo "Install options:"
          echo "  1. Official: curl -fsSL https://bun.sh/install | bash"
          echo "  2. macOS: brew install oven-sh/bun/bun"
          echo "  3. Windows: powershell -c \"irm bun.sh/install.ps1 | iex\""
          exit 1
        fi

        # Get installed version (e.g., "1.3" from "1.3.3")
        INSTALLED=$(bun --version | cut -d. -f1,2)

        if [ "$INSTALLED" = "$EXPECTED" ]; then
          echo "OK: bun $(bun --version) (matches expected $EXPECTED.x)"
          exit 0
        fi

        # Version mismatch - just warn for bun (unlike Go, bun versions are generally compatible)
        echo "WARN: Bun version mismatch"
        echo "  Expected: $EXPECTED.x (from versions.env)"
        echo "  Installed: $(bun --version)"
        echo ""
        echo "This is usually fine - bun versions are generally compatible."

  check:validate:
    desc: Smoke test Bun works
    cmds:
      - |
        echo "Validating Bun..."
        bun --version
        echo "bun:check:validate passed"

  check:health:
    desc: Check npm registry is reachable
    cmds:
      - |
        echo "Checking npm registry..."
        # Simple connectivity check - ping registry
        if bun pm ls 2>/dev/null | head -1 >/dev/null; then
          echo "npm registry reachable"
        fi
        echo "bun:check:health passed"
