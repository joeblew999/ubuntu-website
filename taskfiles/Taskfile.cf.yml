# Cloudflare Tasks
#
# Cloudflare Pages management, cache purging, and dashboard shortcuts.
# NOTE: Deployments now happen automatically via Git integration.
#
# REQUIRES: wrangler (installed via Bun)
#
# Usage:
#   task cf:status      - Check deployment status
#   task cf:logs        - View deployment logs
#   task cf:purge       - Purge CDN cache
#   task cf:open        - Open Pages dashboard

version: '3'

vars:
  # Cloudflare Dashboard URLs
  CF_DASH_BASE: 'https://dash.cloudflare.com/{{.CF_ACCOUNT_ID}}'
  CF_DASH_DOMAIN: '{{.CF_DASH_BASE}}/ubuntusoftware.net'
  CF_DASH_PAGES: '{{.CF_DASH_BASE}}/pages/view/{{.PROJECT_NAME}}'
  CF_DASH_PAGES_SETTINGS: '{{.CF_DASH_PAGES}}/settings/production'

tasks:
  # ===========================================================================
  # Checks
  # ===========================================================================

  check:deps:
    desc: Ensure wrangler CLI is available
    cmds:
      - task: :wrangler:check:deps

  check:validate:
    desc: Validate wrangler can access Cloudflare
    deps: [check:deps]
    cmds:
      - |
        # Quick validation that wrangler can list projects
        if {{.WRANGLER_CMD}} pages project list --json 2>/dev/null | head -1 >/dev/null; then
          echo "OK: wrangler can access Cloudflare"
        else
          echo "WARN: Could not validate Cloudflare access (may need login)"
        fi

  # ===========================================================================
  # Status & Logs
  # ===========================================================================

  status:
    desc: Check deployment status
    deps: [check:deps]
    cmds:
      - |
        echo "========================================"
        echo "Cloudflare Pages Status"
        echo "========================================"
        echo "Project: {{.PROJECT_NAME}}"
        echo ""
        echo "URLs:"
        echo "  Production: {{.URL_PRODUCTION}}"
        echo "  Preview: {{.URL_PREVIEW}}"
        echo ""
        echo "Dashboards:"
        echo "  Pages: {{.CF_DASH_PAGES}}"
        echo "  Settings: {{.CF_DASH_PAGES_SETTINGS}}"
        echo ""
        echo "Recent Deployments:"
        echo "========================================"
      - '{{.WRANGLER_CMD}} pages deployment list --project-name={{.PROJECT_NAME}}'

  logs:
    desc: View deployment logs
    deps: [check:deps]
    cmds:
      - |
        echo "========================================"
        echo "Recent Deployments"
        echo "========================================"
        echo "Dashboard: {{.CF_DASH_PAGES}}"
        echo ""
      - '{{.WRANGLER_CMD}} pages deployment list --project-name={{.PROJECT_NAME}} | head -10'

  tail:
    desc: Tail latest deployment logs
    deps: [check:deps]
    cmds:
      - |
        echo "========================================"
        echo "Tailing Deployment Logs"
        echo "========================================"
        echo "Dashboard: {{.CF_DASH_PAGES}}"
        echo ""
      - '{{.WRANGLER_CMD}} pages deployment tail --project-name={{.PROJECT_NAME}}'

  preview-url:
    desc: Get and open the latest preview deployment URL
    deps: [check:deps]
    cmds:
      - |
        echo "========================================"
        echo "Latest Preview Deployment"
        echo "========================================"
        LATEST_URL=$({{.WRANGLER_CMD}} pages deployment list --project-name={{.PROJECT_NAME}} | grep "Preview" | head -1 | awk '{print $10}')
        if [ -n "$LATEST_URL" ]; then
          echo "URL: $LATEST_URL"
          echo ""
          echo "Opening in browser..."
          open "$LATEST_URL"
        else
          echo "No preview deployments found"
        fi

  # ===========================================================================
  # Cache
  # ===========================================================================

  purge:
    desc: Purge Cloudflare CDN cache
    cmds:
      - |
        if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
          echo "ERROR: CLOUDFLARE_API_TOKEN must be set in .env"
          exit 1
        fi
        echo "Purging Cloudflare cache for {{.DOMAIN}}..."
        RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/{{.CF_ZONE_ID}}/purge_cache" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}')

        if echo "$RESPONSE" | grep -q '"success": true'; then
          echo "OK: Cache purged successfully"
        else
          echo "ERROR: Cache purge failed:"
          echo "$RESPONSE" | jq . 2>/dev/null || echo "$RESPONSE"
          exit 1
        fi

  # ===========================================================================
  # Secrets
  # ===========================================================================

  secret:set:
    desc: Set a secret for Cloudflare Pages (e.g., HUGO_VERSION)
    deps: [check:deps]
    cmds:
      - 'echo "Setting secret for Pages project..."'
      - '{{.WRANGLER_CMD}} pages secret put {{.CLI_ARGS}} --project-name={{.PROJECT_NAME}}'

  secret:list:
    desc: List secrets for Cloudflare Pages
    deps: [check:deps]
    cmds:
      - '{{.WRANGLER_CMD}} pages secret list --project-name={{.PROJECT_NAME}}'

  # ===========================================================================
  # Dashboard URLs
  # ===========================================================================

  open:
    desc: Open Cloudflare Pages dashboard in browser
    cmds:
      - open {{.CF_DASH_PAGES}}

  open:settings:
    desc: Open Cloudflare Pages settings in browser
    cmds:
      - open {{.CF_DASH_PAGES_SETTINGS}}

  open:domain:
    desc: Open domain dashboard in browser
    cmds:
      - open {{.CF_DASH_DOMAIN}}

  open:ai:
    desc: Open Cloudflare AI Crawl Control (configure AI bot access)
    cmds:
      - open "https://dash.cloudflare.com/{{.CF_ACCOUNT_ID}}/ubuntusoftware.net/ai"

  open:r2:
    desc: Open Cloudflare R2 dashboard
    cmds:
      - open "https://dash.cloudflare.com/{{.CF_ACCOUNT_ID}}/r2/overview"

  # ===========================================================================
  # Deprecated (kept for reference)
  # ===========================================================================

  login:
    desc: "[DEPRECATED] Login to Cloudflare"
    deps: [check:deps]
    cmds:
      - 'echo "DEPRECATED: This task is no longer needed with Git integration"'
      - '{{.WRANGLER_CMD}} login'

  init:
    desc: "[DEPRECATED] Initialize Cloudflare Pages project"
    deps: [check:deps]
    cmds:
      - 'echo "DEPRECATED: Project is configured via Cloudflare dashboard"'
      - '{{.WRANGLER_CMD}} pages project create {{.PROJECT_NAME}} --production-branch=main'

  deploy:
    desc: "[DEPRECATED] Deploy to Cloudflare Pages - Use git push instead"
    cmds:
      - 'echo "DEPRECATED: Deployments happen automatically on git push"'
      - 'echo "Just run: git push"'
      - exit 1

  delete:
    desc: "[DANGEROUS] Delete Cloudflare Pages project"
    deps: [check:deps]
    cmds:
      - |
        echo "========================================"
        echo "DANGER: DELETE CLOUDFLARE PAGES PROJECT"
        echo "========================================"
        echo ""
        echo "This will PERMANENTLY delete:"
        echo "  Project: {{.PROJECT_NAME}}"
        echo "  Production: {{.URL_PRODUCTION}}"
        echo "  Preview: {{.URL_PREVIEW}}"
        echo ""
        echo "This action CANNOT be undone!"
        echo ""
        read -p "Type 'DELETE {{.PROJECT_NAME}}' to confirm: " CONFIRM
        if [ "$CONFIRM" != "DELETE {{.PROJECT_NAME}}" ]; then
          echo "Cancelled."
          exit 1
        fi
      - '{{.WRANGLER_CMD}} pages project delete {{.PROJECT_NAME}}'

  # ===========================================================================
  # Email Routing
  # ===========================================================================

  email:status:
    desc: Check Email Routing status and list rules
    cmds:
      - |
        if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
          echo "ERROR: CLOUDFLARE_API_TOKEN must be set in .env"
          exit 1
        fi
        echo "========================================"
        echo "Email Routing Status for {{.DOMAIN}}"
        echo "========================================"
        echo ""

        # Get Email Routing settings
        SETTINGS=$(curl -s "https://api.cloudflare.com/client/v4/zones/{{.CF_ZONE_ID}}/email/routing" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json")

        ENABLED=$(echo "$SETTINGS" | jq -r '.result.enabled // "unknown"')
        echo "Email Routing: $ENABLED"
        echo ""

        # List routing rules
        echo "Routing Rules:"
        echo "----------------------------------------"
        RULES=$(curl -s "https://api.cloudflare.com/client/v4/zones/{{.CF_ZONE_ID}}/email/routing/rules" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json")

        echo "$RULES" | jq -r '.result[] | "  \(.matchers[0].value // "catch-all") â†’ \(.actions[0].value[0] // "drop") [\(if .enabled then "enabled" else "disabled" end)]"' 2>/dev/null || echo "  No rules configured"
        echo ""

        # List destination addresses
        echo "Verified Destinations:"
        echo "----------------------------------------"
        DESTS=$(curl -s "https://api.cloudflare.com/client/v4/accounts/{{.CF_ACCOUNT_ID}}/email/routing/addresses" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json")

        echo "$DESTS" | jq -r '.result[] | "  \(.email) [\(.verified | if . then "verified" else "pending" end)]"' 2>/dev/null || echo "  No destinations"

  email:add:
    desc: 'Add email forwarding rule (FROM=contact@domain.com TO=destination@gmail.com)'
    requires:
      vars: [FROM, TO]
    cmds:
      - |
        if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
          echo "ERROR: CLOUDFLARE_API_TOKEN must be set in .env"
          exit 1
        fi

        echo "========================================"
        echo "Adding Email Routing Rule"
        echo "========================================"
        echo "  From: {{.FROM}}"
        echo "  To:   {{.TO}}"
        echo ""

        # First, ensure destination is verified
        echo "Checking destination address..."
        DESTS=$(curl -s "https://api.cloudflare.com/client/v4/accounts/{{.CF_ACCOUNT_ID}}/email/routing/addresses" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json")

        VERIFIED=$(echo "$DESTS" | jq -r --arg to "{{.TO}}" '.result[] | select(.email == $to) | .verified')

        if [ "$VERIFIED" != "true" ]; then
          echo "Destination {{.TO}} not verified. Adding..."
          ADD_DEST=$(curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/{{.CF_ACCOUNT_ID}}/email/routing/addresses" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"email": "{{.TO}}"}')

          if echo "$ADD_DEST" | jq -e '.success' >/dev/null 2>&1; then
            echo "Verification email sent to {{.TO}}"
            echo "Please verify before continuing."
            exit 0
          else
            echo "Note: Destination may already exist or require verification"
          fi
        else
          echo "OK: Destination {{.TO}} is verified"
        fi

        # Create the routing rule
        echo ""
        echo "Creating routing rule..."
        RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/{{.CF_ZONE_ID}}/email/routing/rules" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json" \
          --data '{
            "actions": [{"type": "forward", "value": ["{{.TO}}"]}],
            "matchers": [{"type": "literal", "field": "to", "value": "{{.FROM}}"}],
            "enabled": true,
            "name": "Forward {{.FROM}} to {{.TO}}"
          }')

        if echo "$RESPONSE" | jq -e '.success' >/dev/null 2>&1; then
          echo "OK: Routing rule created successfully!"
          echo ""
          echo "Emails to {{.FROM}} will now forward to {{.TO}}"
        else
          ERROR=$(echo "$RESPONSE" | jq -r '.errors[0].message // "Unknown error"')
          echo "ERROR: $ERROR"
          echo ""
          echo "Full response:"
          echo "$RESPONSE" | jq .
          exit 1
        fi

  email:remove:
    desc: 'Remove email forwarding rule (FROM=contact@domain.com)'
    requires:
      vars: [FROM]
    cmds:
      - |
        if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
          echo "ERROR: CLOUDFLARE_API_TOKEN must be set in .env"
          exit 1
        fi

        echo "Removing routing rule for {{.FROM}}..."

        # Find the rule ID
        RULES=$(curl -s "https://api.cloudflare.com/client/v4/zones/{{.CF_ZONE_ID}}/email/routing/rules" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json")

        RULE_ID=$(echo "$RULES" | jq -r --arg from "{{.FROM}}" '.result[] | select(.matchers[0].value == $from) | .tag')

        if [ -z "$RULE_ID" ] || [ "$RULE_ID" = "null" ]; then
          echo "ERROR: No routing rule found for {{.FROM}}"
          exit 1
        fi

        # Delete the rule
        RESPONSE=$(curl -s -X DELETE "https://api.cloudflare.com/client/v4/zones/{{.CF_ZONE_ID}}/email/routing/rules/$RULE_ID" \
          -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
          -H "Content-Type: application/json")

        if echo "$RESPONSE" | jq -e '.success' >/dev/null 2>&1; then
          echo "OK: Routing rule removed"
        else
          echo "ERROR: Failed to remove rule"
          echo "$RESPONSE" | jq .
          exit 1
        fi

  email:open:
    desc: Open Cloudflare Email Routing dashboard
    cmds:
      - open "https://dash.cloudflare.com/{{.CF_ACCOUNT_ID}}/{{.DOMAIN}}/email/routing/routes"
