# Airspace Demo Tasks
#
# Interactive map showing FAA airspace data for BVLOS development.
# Serves as demo/proof-of-capability for data provider applications.
#
# Usage:
#   task airspace:open      - Open demo in browser (via Hugo dev server)
#   task airspace:sync      - Smart sync (only downloads changed data)
#   task airspace:tile      - Convert GeoJSON to PMTiles (requires tippecanoe)
#   task airspace:install   - Install tippecanoe and go-pmtiles
#
# The demo is a Hugo page at /fleet/airspace-demo/ - run `task dev` first.
# Data URL (R2) is configured in config/_default/params.toml
#
# Configuration:
#   Single source of truth: data/airspace/datasets.json
#   Filenames and layer names here MUST match that file.
#   See also: cmd/airspace/main.go, layouts/fleet/airspace-demo.html

version: '3'

vars:
  AIRSPACE_DATA_DIR: static/airspace
  PMTILES_DIR: static/airspace/tiles

tasks:
  # ===========================================================================
  # Demo Access
  # ===========================================================================

  open:
    desc: Open airspace demo in browser (requires Hugo dev server)
    cmds:
      - open http://localhost:1313/fleet/airspace-demo/

  # ===========================================================================
  # Data Management
  # ===========================================================================

  sync:
    desc: Smart sync FAA data (only downloads if changed)
    cmds:
      - go run ./cmd/airspace sync -output {{.AIRSPACE_DATA_DIR}}

  sync:force:
    desc: Force re-download all FAA data
    cmds:
      - go run ./cmd/airspace sync -output {{.AIRSPACE_DATA_DIR}} -force

  download:
    desc: Download/refresh FAA airspace data (use sync instead)
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}}

  download:uas:
    desc: Download only UAS Facility Map (LAANC)
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}} -dataset uas

  download:boundary:
    desc: Download only Airspace Boundary
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}} -dataset boundary

  download:sua:
    desc: Download only Special Use Airspace
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}} -dataset sua

  download:airports:
    desc: Download only Airports
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}} -dataset airports

  download:navaids:
    desc: Download only Navigation Aids
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}} -dataset navaids

  download:obstacles:
    desc: Download only Obstacles
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}} -dataset obstacles

  status:
    desc: Show airspace data status
    cmds:
      - go run ./cmd/airspace status -output {{.AIRSPACE_DATA_DIR}}

  # ===========================================================================
  # Tool Installation (OS-aware)
  # ===========================================================================

  install:
    desc: Install tippecanoe and go-pmtiles (OS-aware)
    cmds:
      - task: install:tippecanoe
      - task: install:pmtiles

  install:tippecanoe:
    desc: Install tippecanoe (GeoJSON to vector tiles)
    status:
      - which tippecanoe
    cmds:
      - |
        echo "Installing tippecanoe..."
        case "{{OS}}" in
          darwin)
            brew install tippecanoe
            ;;
          linux)
            # Ubuntu/Debian
            if command -v apt-get &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y tippecanoe
            # Fedora/RHEL
            elif command -v dnf &> /dev/null; then
              sudo dnf install -y tippecanoe
            else
              echo "Building from source..."
              cd /tmp
              git clone https://github.com/felt/tippecanoe.git
              cd tippecanoe
              make -j
              sudo make install
            fi
            ;;
          *)
            echo "Unsupported OS: {{OS}}"
            echo "Install manually from: https://github.com/felt/tippecanoe"
            exit 1
            ;;
        esac
      - tippecanoe --version

  install:pmtiles:
    desc: Install go-pmtiles CLI
    status:
      - which go-pmtiles
    cmds:
      - go install github.com/protomaps/go-pmtiles@latest
      - go-pmtiles version

  # ===========================================================================
  # Vector Tile Generation
  # ===========================================================================

  tile:
    desc: Convert all GeoJSON to PMTiles (individual files)
    deps: [install:tippecanoe]
    cmds:
      - mkdir -p {{.PMTILES_DIR}}
      - task: tile:boundary
      - task: tile:sua
      - task: tile:airports
      - task: tile:navaids
      - task: tile:uas
      - echo "Done. PMTiles at {{.PMTILES_DIR}}/"

  tile:combined:
    desc: Create single combined PMTiles with all layers
    deps: [install:tippecanoe]
    cmds:
      - mkdir -p {{.PMTILES_DIR}}
      - |
        echo "Creating combined airspace PMTiles..."
        tippecanoe -zg -o {{.PMTILES_DIR}}/faa_airspace_combined.pmtiles \
          --force \
          --named-layer=boundary:{{.AIRSPACE_DATA_DIR}}/faa_airspace_boundary.geojson \
          --named-layer=sua:{{.AIRSPACE_DATA_DIR}}/faa_special_use_airspace.geojson \
          --named-layer=airports:{{.AIRSPACE_DATA_DIR}}/faa_airports.geojson \
          --named-layer=navaids:{{.AIRSPACE_DATA_DIR}}/faa_navaids.geojson \
          --drop-densest-as-needed
      - |
        echo ""
        echo "Combined PMTiles created:"
        ls -lh {{.PMTILES_DIR}}/faa_airspace_combined.pmtiles
        echo ""
        echo "Layers included: boundary, sua, airports, navaids"

  tile:boundary:
    desc: Convert airspace boundary to PMTiles
    cmds:
      - |
        tippecanoe -zg -o {{.PMTILES_DIR}}/faa_airspace_boundary.pmtiles \
          --layer=boundary \
          --force \
          {{.AIRSPACE_DATA_DIR}}/faa_airspace_boundary.geojson
    status:
      - test {{.PMTILES_DIR}}/faa_airspace_boundary.pmtiles -nt {{.AIRSPACE_DATA_DIR}}/faa_airspace_boundary.geojson

  tile:sua:
    desc: Convert special use airspace to PMTiles
    cmds:
      - |
        tippecanoe -zg -o {{.PMTILES_DIR}}/faa_special_use_airspace.pmtiles \
          --layer=sua \
          --force \
          {{.AIRSPACE_DATA_DIR}}/faa_special_use_airspace.geojson
    status:
      - test {{.PMTILES_DIR}}/faa_special_use_airspace.pmtiles -nt {{.AIRSPACE_DATA_DIR}}/faa_special_use_airspace.geojson

  tile:airports:
    desc: Convert airports to PMTiles
    cmds:
      - |
        tippecanoe -Z0 -z10 -o {{.PMTILES_DIR}}/faa_airports.pmtiles \
          --layer=airports \
          --force \
          --no-feature-limit \
          --no-tile-size-limit \
          -r1 \
          {{.AIRSPACE_DATA_DIR}}/faa_airports.geojson
    status:
      - test {{.PMTILES_DIR}}/faa_airports.pmtiles -nt {{.AIRSPACE_DATA_DIR}}/faa_airports.geojson

  tile:navaids:
    desc: Convert navaids to PMTiles
    cmds:
      - |
        tippecanoe -Z0 -z10 -o {{.PMTILES_DIR}}/faa_navaids.pmtiles \
          --layer=navaids \
          --force \
          --no-feature-limit \
          --no-tile-size-limit \
          -r1 \
          {{.AIRSPACE_DATA_DIR}}/faa_navaids.geojson
    status:
      - test {{.PMTILES_DIR}}/faa_navaids.pmtiles -nt {{.AIRSPACE_DATA_DIR}}/faa_navaids.geojson

  tile:uas:
    desc: Convert UAS Facility Map (LAANC) to PMTiles
    cmds:
      - |
        tippecanoe -Z0 -z10 -r1 -o {{.PMTILES_DIR}}/faa_uas_facility_map.pmtiles \
          --layer=uas \
          --force \
          --no-feature-limit \
          --no-tile-size-limit \
          {{.AIRSPACE_DATA_DIR}}/faa_uas_facility_map.geojson
    status:
      - test {{.PMTILES_DIR}}/faa_uas_facility_map.pmtiles -nt {{.AIRSPACE_DATA_DIR}}/faa_uas_facility_map.geojson

  tile:obstacles:
    desc: Convert obstacles to PMTiles (large file - 575MB)
    cmds:
      - |
        echo "Converting obstacles (this may take a while)..."
        tippecanoe -zg -o {{.PMTILES_DIR}}/faa_obstacles.pmtiles \
          --layer=obstacles \
          --force \
          --drop-densest-as-needed \
          {{.AIRSPACE_DATA_DIR}}/faa_obstacles.geojson
    status:
      - test {{.PMTILES_DIR}}/faa_obstacles.pmtiles -nt {{.AIRSPACE_DATA_DIR}}/faa_obstacles.geojson

  tile:status:
    desc: Show PMTiles file status
    cmds:
      - |
        echo "PMTiles Status"
        echo "=============="
        if [ -d "{{.PMTILES_DIR}}" ]; then
          ls -lh {{.PMTILES_DIR}}/*.pmtiles 2>/dev/null || echo "No PMTiles files"
        else
          echo "No tiles directory. Run: task airspace:tile"
        fi

  # ===========================================================================
  # Checks
  # ===========================================================================

  check:deps:
    desc: Check airspace data and R2 config
    cmds:
      - |
        echo "Checking airspace setup..."

        # Check R2 config in params.toml
        if grep -q "r2.public_url" config/_default/params.toml 2>/dev/null; then
          echo "OK: R2 URL configured in params.toml"
        else
          echo "WARNING: R2 URL not found in params.toml"
        fi

        # Check Hugo layout
        if [ -f "layouts/fleet/airspace-demo.html" ]; then
          echo "OK: Hugo layout exists"
        else
          echo "ERROR: Missing layouts/fleet/airspace-demo.html"
          exit 1
        fi

        # Check local data (for downloads)
        if [ -d "{{.AIRSPACE_DATA_DIR}}" ]; then
          echo "OK: Local data present at {{.AIRSPACE_DATA_DIR}}"
        else
          echo "INFO: No local data. Run: task airspace:download"
        fi
