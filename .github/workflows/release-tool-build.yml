# Reusable Tool Build & Release Workflow
#
# All build logic lives in each tool's Taskfile (via :toolchain:golang:build).
# This workflow is a thin wrapper that:
#   1. Sets up Go environment
#   2. Installs Task
#   3. Calls <tool>:release:build with GOOS/GOARCH env vars
#   4. Uploads artifacts / creates release
#
# Called by release-tools.yml for building Go binary tools.

name: "Build Tool (Reusable)"

on:
  workflow_call:
    inputs:
      tool:
        description: 'Tool name (e.g., sitecheck, analytics)'
        required: true
        type: string
      version:
        description: 'Version (e.g., v0.1.0)'
        required: true
        type: string
      is_release:
        description: 'Whether this is a tag-triggered release'
        required: true
        type: boolean
      go_version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.25'

env:
  TOOL: ${{ inputs.tool }}
  RELEASE_VERSION: ${{ inputs.version }}

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # Single command - all logic in Taskfile
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          RELEASE_VERSION: ${{ inputs.version }}
        run: task ${{ inputs.tool }}:release:build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.tool }}-${{ matrix.goos }}-${{ matrix.goarch }}
          path: bin/${{ inputs.tool }}-${{ matrix.goos }}-${{ matrix.goarch }}*

  test:
    needs: build
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.TOOL }}-${{ matrix.goos }}-${{ matrix.goarch }}
          path: bin

      # Single command - all logic in Taskfile
      - name: Test binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: task ${{ inputs.tool }}:release:test

  release:
    needs: [build, test]
    runs-on: ubuntu-latest
    if: ${{ inputs.is_release }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f -name "${TOOL}-*" -exec mv {} release/ \;
          echo "=== Release files ==="
          ls -la release/

      - name: Generate release notes
        run: |
          cat > /tmp/release-notes.md << EOF
          ## ${TOOL} ${RELEASE_VERSION}

          ### Installation

          Via xplat (recommended):
          \`\`\`bash
          xplat binary install ${TOOL} ${RELEASE_VERSION} ${{ github.repository }}
          \`\`\`

          Or download directly:
          \`\`\`bash
          # macOS (Apple Silicon)
          curl -sL https://github.com/${{ github.repository }}/releases/download/${TOOL}-${RELEASE_VERSION}/${TOOL}-darwin-arm64 -o ~/.local/bin/${TOOL}
          chmod +x ~/.local/bin/${TOOL}

          # macOS (Intel)
          curl -sL https://github.com/${{ github.repository }}/releases/download/${TOOL}-${RELEASE_VERSION}/${TOOL}-darwin-amd64 -o ~/.local/bin/${TOOL}
          chmod +x ~/.local/bin/${TOOL}

          # Linux (x86_64)
          curl -sL https://github.com/${{ github.repository }}/releases/download/${TOOL}-${RELEASE_VERSION}/${TOOL}-linux-amd64 -o ~/.local/bin/${TOOL}
          chmod +x ~/.local/bin/${TOOL}
          \`\`\`

          ### Usage

          \`\`\`
          ${TOOL} -version    # Print version
          ${TOOL} -help       # Show help
          \`\`\`

          See [README](https://github.com/${{ github.repository }}/tree/main/cmd/${TOOL}) for full documentation.
          EOF

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${TOOL}-${RELEASE_VERSION}" \
            --repo "${{ github.repository }}" \
            --title "${TOOL} ${RELEASE_VERSION}" \
            --notes-file /tmp/release-notes.md \
            release/*
