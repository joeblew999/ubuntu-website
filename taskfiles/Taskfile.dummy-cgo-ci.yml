# Dummy-CGO Tool CI Taskfile
# Self-contained taskfile for CI testing of CGO=1 tools
#
# Usage in workflow: task -t taskfiles/Taskfile.dummy-cgo-ci.yml <task>
# IMPORTANT: Run from repo root, not from taskfiles/ directory
#
# Expected behavior:
#   - CGO=1: Each platform builds only its own binaries
#   - Linux builds linux-amd64, linux-arm64
#   - macOS builds darwin-amd64, darwin-arm64
#   - Windows builds windows-amd64, windows-arm64
#
version: '3'

vars:
  # Core paths - always use absolute HOME-based paths
  BIN_INSTALL_DIR: '{{if eq OS "windows"}}{{toSlash .HOME}}/bin{{else}}{{.HOME}}/.local/bin{{end}}'
  XPLAT_BIN: '{{.BIN_INSTALL_DIR}}/xplat{{exeExt}}'

  # Dummy-CGO tool config
  DUMMY_CGO_VERSION: v0.0.1
  DUMMY_CGO_REPO: joeblew999/ubuntu-website
  DUMMY_CGO_BIN: 'dummy-cgo{{exeExt}}'
  DUMMY_CGO_CGO: '1'  # KEY: CGO enabled

tasks:
  # ===========================================================================
  # Dummy-CGO tasks
  # ===========================================================================

  check:deps:
    desc: Ensure dummy-cgo binary is available
    status:
      - test -f "{{.BIN_INSTALL_DIR}}/{{.DUMMY_CGO_BIN}}"
    cmds:
      - '{{.XPLAT_BIN}} binary install dummy-cgo {{.DUMMY_CGO_VERSION}} {{.DUMMY_CGO_REPO}} --source "{{toSlash .USER_WORKING_DIR}}/cmd/dummy-cgo"'

  run:
    desc: Run the dummy-cgo binary
    deps: [check:deps]
    cmds:
      - '"{{.BIN_INSTALL_DIR}}/{{.DUMMY_CGO_BIN}}"'

  build:
    desc: Build dummy-cgo binary locally
    vars:
      TARGET_OS: '{{if env "GOOS"}}{{env "GOOS"}}{{else}}{{OS}}{{end}}'
      TARGET_ARCH: '{{if env "GOARCH"}}{{env "GOARCH"}}{{else}}{{ARCH}}{{end}}'
      EXT: '{{if eq .TARGET_OS "windows"}}.exe{{end}}'
      BIN_BASE: '{{trimSuffix ".exe" .DUMMY_CGO_BIN}}'
      BUILD_DIR: '{{.USER_WORKING_DIR}}/.build'
      OUTPUT: '{{.BUILD_DIR}}/{{.BIN_BASE}}-{{.TARGET_OS}}-{{.TARGET_ARCH}}{{.EXT}}'
    cmds:
      - mkdir -p "{{.BUILD_DIR}}"
      - |
        echo "Building {{.BIN_BASE}} dev for {{.TARGET_OS}}/{{.TARGET_ARCH}} (CGO={{.DUMMY_CGO_CGO}})..."
        CGO_ENABLED={{.DUMMY_CGO_CGO}} GOWORK=off \
        GOOS={{.TARGET_OS}} GOARCH={{.TARGET_ARCH}} \
        go build -ldflags="-s -w -X main.version=dev" \
        -o "{{.OUTPUT}}" "{{toSlash .USER_WORKING_DIR}}/cmd/dummy-cgo"
        echo "Output: {{.OUTPUT}}"

  release:build:
    desc: Build dummy-cgo for release (current platform only for CGO=1)
    vars:
      TARGET_OS: '{{if env "GOOS"}}{{env "GOOS"}}{{else}}{{OS}}{{end}}'
      TARGET_ARCH: '{{if env "GOARCH"}}{{env "GOARCH"}}{{else}}{{ARCH}}{{end}}'
      EXT: '{{if eq .TARGET_OS "windows"}}.exe{{end}}'
      BIN_BASE: '{{trimSuffix ".exe" .DUMMY_CGO_BIN}}'
      VERSION: '{{.RELEASE_VERSION | default .DUMMY_CGO_VERSION}}'
      BUILD_DIR: '{{.USER_WORKING_DIR}}/.build'
      OUTPUT: '{{.BUILD_DIR}}/{{.BIN_BASE}}-{{.TARGET_OS}}-{{.TARGET_ARCH}}{{.EXT}}'
    cmds:
      - mkdir -p "{{.BUILD_DIR}}"
      - |
        echo "Building {{.BIN_BASE}} {{.VERSION}} for {{.TARGET_OS}}/{{.TARGET_ARCH}} (CGO={{.DUMMY_CGO_CGO}})..."
        CGO_ENABLED={{.DUMMY_CGO_CGO}} GOWORK=off \
        GOOS={{.TARGET_OS}} GOARCH={{.TARGET_ARCH}} \
        go build -ldflags="-s -w -X main.version={{.VERSION}}" \
        -o "{{.OUTPUT}}" "{{toSlash .USER_WORKING_DIR}}/cmd/dummy-cgo"
        echo "Output: {{.OUTPUT}}"

  release:test:
    desc: Test built dummy-cgo binary
    vars:
      TARGET_OS: '{{if env "GOOS"}}{{env "GOOS"}}{{else}}{{OS}}{{end}}'
      TARGET_ARCH: '{{if env "GOARCH"}}{{env "GOARCH"}}{{else}}{{ARCH}}{{end}}'
      EXT: '{{if eq .TARGET_OS "windows"}}.exe{{end}}'
      BIN_BASE: '{{trimSuffix ".exe" .DUMMY_CGO_BIN}}'
      BUILD_DIR: '{{.USER_WORKING_DIR}}/.build'
      BINARY: '{{.BUILD_DIR}}/{{.BIN_BASE}}-{{.TARGET_OS}}-{{.TARGET_ARCH}}{{.EXT}}'
    cmds:
      - |
        echo "Testing {{.BIN_BASE}}..."
        if [ ! -f "{{.BINARY}}" ]; then
          echo "ERROR: Binary not found: {{.BINARY}}"
          exit 1
        fi
        chmod +x "{{.BINARY}}" 2>/dev/null || true
        "{{.BINARY}}"
        echo "OK: {{.BIN_BASE}} binary works"

  release:cross:
    desc: Build for current platform (CGO=1 - no cross-compile)
    cmds:
      - '{{.XPLAT_BIN}} release build dummy-cgo'
