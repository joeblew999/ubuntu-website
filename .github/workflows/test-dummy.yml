# Test workflow for dummy tools FULL round-trip
# Tests BOTH CGO=0 and CGO=1 to validate xplat smart build:
#
# CGO=0 (dummy):     Linux builds ALL 6 platforms, creates release, verify on 3 platforms
# CGO=1 (dummy-cgo): Each platform builds native + uploads to shared release, verify on 3 platforms
#
# Uses gh taskfile for release operations (no upload-artifact)
#
# Bootstrap: xplat embeds Task, so we only need to build xplat from source.
#
name: "Test: Dummy Round-Trip"

on:
  workflow_dispatch:
  push:
    paths:
      - 'cmd/dummy/**'
      - 'cmd/dummy-cgo/**'
      - 'cmd/xplat/**'
      - 'taskfiles/Taskfile.dummy*.yml'
      - 'taskfiles/toolchain/Taskfile.golang.yml'
      - 'taskfiles/tools/Taskfile.xplat.yml'
      - '.github/workflows/test-dummy.yml'

env:
  # Test release tag - includes run ID to avoid conflicts
  DUMMY_TEST_VERSION: v0.0.0-test-${{ github.run_id }}
  DUMMY_CGO_TEST_VERSION: v0.0.0-cgo-test-${{ github.run_id }}
  GH_TOKEN: ${{ github.token }}

jobs:
  # ===========================================================================
  # CGO=0: Linux builds all 6, creates release
  # ===========================================================================
  build-cgo0:
    name: "CGO=0 Build & Release"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build xplat (with embedded Task)
        run: |
          mkdir -p "$HOME/.local/bin"
          go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify xplat task
        run: xplat task --version

      - name: Build dummy (dev)
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml build

      - name: Release build
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:build

      - name: Test release binary
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:test

      - name: Cross-compile all 6 platforms
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:cross

      - name: Verify all 6 binaries
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-*
          for BINARY in dummy-linux-amd64 dummy-linux-arm64 dummy-darwin-amd64 dummy-darwin-arm64 dummy-windows-amd64.exe dummy-windows-arm64.exe; do
            if [ ! -f ".build/$BINARY" ]; then
              echo "ERROR: Missing .build/$BINARY"
              exit 1
            fi
          done
          echo "OK: All 6 platform binaries built"

      - name: Run dummy
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml run

      - name: Create test release
        run: |
          xplat task tools:gh:release:delete -- "dummy-${{ env.DUMMY_TEST_VERSION }}" || true
          xplat task tools:gh:release:create-with-assets -- "dummy-${{ env.DUMMY_TEST_VERSION }}" .build/dummy-linux-amd64 .build/dummy-linux-arm64 .build/dummy-darwin-amd64 .build/dummy-darwin-arm64 .build/dummy-windows-amd64.exe .build/dummy-windows-arm64.exe

  # ===========================================================================
  # CGO=0: Verify downloaded binary works on each platform
  # ===========================================================================
  verify-cgo0:
    name: "CGO=0 Verify (${{ matrix.os }})"
    needs: build-cgo0
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            binary: dummy-linux-amd64
          - os: macos-latest
            binary: dummy-darwin-arm64
          - os: windows-latest
            binary: dummy-windows-amd64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download and verify binary
        shell: bash
        run: |
          URL="https://github.com/${{ github.repository }}/releases/download/dummy-${{ env.DUMMY_TEST_VERSION }}/${{ matrix.binary }}"
          echo "Downloading: $URL"
          curl -sL "$URL" -o dummy
          chmod +x dummy 2>/dev/null || true
          ./dummy
          echo "OK: Downloaded binary works!"

  # ===========================================================================
  # CGO=0: Cleanup test release
  # ===========================================================================
  cleanup-cgo0:
    name: "CGO=0 Cleanup"
    needs: verify-cgo0
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build xplat
        run: |
          mkdir -p "$HOME/.local/bin"
          go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Delete test release
        run: xplat task tools:gh:release:delete -- "dummy-${{ env.DUMMY_TEST_VERSION }}" || true

  # ===========================================================================
  # CGO=1: Create empty release first
  # ===========================================================================
  create-release-cgo1:
    name: "CGO=1 Create Release"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build xplat
        run: |
          mkdir -p "$HOME/.local/bin"
          go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create empty release
        run: |
          xplat task tools:gh:release:delete -- "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" || true
          xplat task tools:gh:release:create -- "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}"

  # ===========================================================================
  # CGO=1: Each platform builds + uploads to the shared release
  # ===========================================================================
  build-cgo1:
    name: "CGO=1 Build (${{ matrix.os }})"
    needs: create-release-cgo1
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set HOME on Windows
        if: runner.os == 'Windows'
        shell: bash
        run: echo "HOME=$USERPROFILE" >> $GITHUB_ENV

      - name: Build xplat (with embedded Task)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            mkdir -p "$HOME/bin"
            go build -o "$HOME/bin/xplat.exe" ./cmd/xplat
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            mkdir -p "$HOME/.local/bin"
            go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Verify xplat task
        shell: bash
        run: xplat task --version

      - name: Build dummy-cgo (dev)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml build

      - name: Release build
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml release:build

      - name: Test release binary
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml release:test

      - name: Platform build (xplat smart build)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml release:cross

      - name: Upload binaries to release (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Uploading Linux binary..."
          ls -la .build/dummy-cgo-*
          xplat task tools:gh:release:upload -- "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" .build/dummy-cgo-linux-amd64

      - name: Upload binaries to release (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          echo "Uploading macOS binaries..."
          ls -la .build/dummy-cgo-*
          xplat task tools:gh:release:upload -- "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" .build/dummy-cgo-darwin-amd64 .build/dummy-cgo-darwin-arm64

      - name: Upload binaries to release (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "Uploading Windows binary..."
          ls -la .build/dummy-cgo-*
          xplat task tools:gh:release:upload -- "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" .build/dummy-cgo-windows-amd64.exe

      - name: Run dummy-cgo
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml run

  # ===========================================================================
  # CGO=1: Verify downloaded binary works on each platform
  # ===========================================================================
  verify-cgo1:
    name: "CGO=1 Verify (${{ matrix.os }})"
    needs: build-cgo1
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            binary: dummy-cgo-linux-amd64
          - os: macos-latest
            binary: dummy-cgo-darwin-arm64
          - os: windows-latest
            binary: dummy-cgo-windows-amd64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download and verify binary
        shell: bash
        run: |
          URL="https://github.com/${{ github.repository }}/releases/download/dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}/${{ matrix.binary }}"
          echo "Downloading: $URL"
          curl -sL "$URL" -o dummy-cgo
          chmod +x dummy-cgo 2>/dev/null || true
          ./dummy-cgo
          echo "OK: Downloaded CGO=1 binary works!"

  # ===========================================================================
  # CGO=1: Cleanup test release
  # ===========================================================================
  cleanup-cgo1:
    name: "CGO=1 Cleanup"
    needs: verify-cgo1
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build xplat
        run: |
          mkdir -p "$HOME/.local/bin"
          go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Delete test release
        run: xplat task tools:gh:release:delete -- "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" || true
