{{ define "main" }}
{{/* Airspace Demo - Full-screen interactive map */}}
{{/* Hugo reads data/airspace/manifest_usa.json at build time */}}
{{/* To add a new dataset: update Go code → regenerate manifest → Hugo rebuilds */}}

{{ $manifest := site.Data.airspace.manifest_usa }}

<style>
    /* Override theme styles for full-screen map */
    main { padding: 0 !important; margin: 0 !important; max-width: 100% !important; }
    .container { max-width: 100% !important; padding: 0 !important; }

    #airspace-map { height: calc(100vh - 80px); width: 100%; }
    .info-panel {
        position: absolute;
        top: 90px;
        right: 10px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        max-width: 300px;
        transition: transform 0.3s ease;
    }
    .info-panel h2 {
        font-size: 14px;
        margin-bottom: 10px;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .panel-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 0 5px;
    }
    .legend { font-size: 12px; }
    .legend-item { display: flex; align-items: center; margin: 5px 0; }
    .legend-color { width: 20px; height: 14px; margin-right: 8px; border: 1px solid #666; }
    .legend-color.point { border-radius: 50%; }
    .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px 40px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        z-index: 2000;
        font-size: 14px;
    }
    .layer-toggle { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
    .layer-toggle label { display: flex; align-items: center; margin: 5px 0; font-size: 12px; cursor: pointer; }
    .layer-toggle input { margin-right: 8px; }
    .data-mode { font-size: 10px; color: #666; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
    .panel-content { transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; }

    /* Mobile styles */
    @media (max-width: 600px) {
        .info-panel {
            top: auto;
            bottom: 10px;
            left: 10px;
            right: 10px;
            max-width: none;
            padding: 10px;
        }
        .info-panel h2 { margin-bottom: 5px; }
        .panel-toggle { display: block; }
        .legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 10px;
        }
        .legend-item { margin: 2px 0; font-size: 11px; }
        .legend-color { width: 16px; height: 12px; margin-right: 5px; }
        .layer-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 10px;
            margin-top: 10px;
            padding-top: 8px;
        }
        .layer-toggle label { margin: 2px 0; font-size: 11px; }
        .data-mode { margin-top: 8px; padding-top: 8px; }

        /* Collapsed state */
        .info-panel.collapsed .panel-content {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        .info-panel.collapsed { padding: 10px; }
        .info-panel.collapsed h2 { margin-bottom: 0; }
    }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div style="position: relative;">
    <div id="airspace-map"></div>
    <div id="loading" class="loading-overlay">Loading airspace data...</div>

    <div class="info-panel" id="info-panel">
        <h2>
            <span>{{ $manifest.name }} Airspace</span>
            <button class="panel-toggle" id="panel-toggle" aria-label="Toggle panel">▼</button>
        </h2>
        <div class="panel-content">
            {{/* Legend - generated from manifest at build time */}}
            <div class="legend">
                {{- range $layerId, $layer := $manifest.layers }}
                {{- range $layer.legend }}
                <div class="legend-item">
                    <div class="legend-color{{ if eq $layer.geom_type "point" }} point{{ end }}" style="background: {{ .color }};"></div>
                    {{ .label }}
                </div>
                {{- end }}
                {{- end }}
            </div>

            {{/* Layer toggles - generated from manifest at build time */}}
            <div class="layer-toggle">
                {{- range $layerId, $layer := $manifest.layers }}
                <label>
                    <input type="checkbox" data-layer="{{ $layerId }}" {{ if $layer.default_visible }}checked{{ end }}>
                    {{ $layer.name }}
                </label>
                {{- end }}
            </div>

            <div class="data-mode">
                Region: {{ $manifest.name }}<br>
                Updated: {{ $manifest.updated | time.Format "2006-01-02" }}<br>
                Source: {{ $manifest.source.authority }}
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>
<script src="https://unpkg.com/protomaps-leaflet@5.1.0/dist/protomaps-leaflet.js"></script>
<script>
    // Data URL - local for dev, R2 for production
    // Detect Hugo dev server by port 1313 (works with localhost, 127.0.0.1, or LAN IPs)
    const isLocalDev = window.location.port === '1313';
    const TILES_BASE = isLocalDev ? '/airspace/tiles' : '{{ site.Params.r2.public_url }}/airspace/tiles';

    console.log('Airspace Demo:', isLocalDev ? 'LOCAL mode' : 'R2 mode', '- Tiles from:', TILES_BASE);

    // Layer configuration - generated by Hugo from manifest at build time
    const LAYERS = {
        {{- range $layerId, $layer := $manifest.layers }}
        "{{ $layerId }}": {
            file: "{{ $layer.file }}",
            pmtilesLayer: "{{ $layer.pmtiles_layer }}",
            geomType: "{{ $layer.geom_type }}",
            defaultVisible: {{ $layer.default_visible }},
            renderRules: [
                {{- range $layer.render_rules }}
                {
                    {{- if .filter_prop }}filterProp: "{{ .filter_prop }}",{{ end }}
                    {{- if .filter_value }}filterValue: "{{ .filter_value }}",{{ end }}
                    fill: "{{ .fill }}",
                    {{- if .stroke }}stroke: "{{ .stroke }}",{{ end }}
                    {{- if .opacity }}opacity: {{ .opacity }},{{ end }}
                    {{- if .width }}width: {{ .width }},{{ end }}
                    {{- if .radius }}radius: {{ .radius }},{{ end }}
                },
                {{- end }}
            ],
        },
        {{- end }}
    };

    // Initialize map centered on continental US
    const map = L.map('airspace-map').setView([39.8, -98.5], 5);

    // Add base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap | Airspace data: FAA'
    }).addTo(map);

    // Store layer references
    const mapLayers = {};

    // Convert render rules to protomaps-leaflet paint rules
    function buildPaintRules(layerId, config) {
        const rules = [];
        for (const rule of config.renderRules) {
            const ruleObj = { dataLayer: config.pmtilesLayer };

            // Add filter if specified
            if (rule.filterProp && rule.filterValue) {
                const prop = rule.filterProp;
                const value = rule.filterValue;
                ruleObj.filter = (z, f) => f.props[prop] === value;
            }

            // Create symbolizer based on geometry type
            const style = {
                fill: rule.fill,
                stroke: rule.stroke || rule.fill,
                opacity: rule.opacity || 0.3,
                width: rule.width || 1,
            };

            if (config.geomType === 'point') {
                style.radius = rule.radius || 5;
                ruleObj.symbolizer = new protomapsL.CircleSymbolizer(style);
            } else {
                ruleObj.symbolizer = new protomapsL.PolygonSymbolizer(style);
            }

            rules.push(ruleObj);
        }
        return rules;
    }

    // Load all layers
    function loadLayers() {
        for (const [layerId, config] of Object.entries(LAYERS)) {
            const pmtilesUrl = `${TILES_BASE}/${config.file}`;
            const paintRules = buildPaintRules(layerId, config);

            console.log(`Loading layer: ${layerId} from ${config.file}`);

            const layer = protomapsL.leafletLayer({
                url: pmtilesUrl,
                paintRules: paintRules,
            });

            mapLayers[layerId] = layer;

            if (config.defaultVisible) {
                layer.addTo(map);
            }
        }
        document.getElementById('loading').style.display = 'none';
    }

    // Setup layer toggle handlers
    function setupToggles() {
        document.querySelectorAll('.layer-toggle input[data-layer]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const layerId = e.target.dataset.layer;
                const layer = mapLayers[layerId];
                if (layer) {
                    e.target.checked ? map.addLayer(layer) : map.removeLayer(layer);
                }
            });
        });
    }

    // Mobile panel toggle
    function setupPanelToggle() {
        const panel = document.getElementById('info-panel');
        const toggle = document.getElementById('panel-toggle');
        toggle.addEventListener('click', () => {
            panel.classList.toggle('collapsed');
            toggle.textContent = panel.classList.contains('collapsed') ? '▲' : '▼';
        });
    }

    // Initialize
    setupToggles();
    setupPanelToggle();
    loadLayers();
</script>
{{ end }}
