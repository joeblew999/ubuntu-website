# Build Codec Static Libraries
#
# This workflow builds x264, libvpx, and opus as static libraries for each
# OS/arch combination, following the yzma/kronk pattern.
#
# The built libraries are uploaded as release artifacts, which the Go-level
# installer (cmd/codeccheck) can download at runtime.
#
# Triggers:
#   - Manual dispatch (workflow_dispatch)
#   - Release creation
#
name: Build Codec Libraries

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v0.1.0'
  release:
    types: [created]

env:
  X264_VERSION: "stable"
  LIBVPX_VERSION: "v1.14.1"
  OPUS_VERSION: "v1.5.2"

jobs:
  # ===========================================================================
  # macOS ARM64 (Apple Silicon)
  # ===========================================================================
  build-darwin-arm64:
    runs-on: macos-14  # M1 runner
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install build dependencies
        run: |
          brew install nasm yasm automake autoconf libtool pkg-config

      - name: Build x264 static library
        run: |
          git clone --depth 1 --branch ${{ env.X264_VERSION }} https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --enable-static --disable-cli --prefix=$GITHUB_WORKSPACE/out
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build libvpx static library
        run: |
          git clone --depth 1 --branch ${{ env.LIBVPX_VERSION }} https://chromium.googlesource.com/webm/libvpx
          cd libvpx
          ./configure --enable-static --disable-shared --disable-examples --disable-tools --prefix=$GITHUB_WORKSPACE/out
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build opus static library
        run: |
          git clone --depth 1 --branch ${{ env.OPUS_VERSION }} https://gitlab.xiph.org/xiph/opus.git
          cd opus
          ./autogen.sh
          ./configure --enable-static --disable-shared --prefix=$GITHUB_WORKSPACE/out
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Package libraries
        run: |
          mkdir -p dist
          tar -czvf dist/codecs-darwin-arm64.tar.gz -C out .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: codecs-darwin-arm64
          path: dist/codecs-darwin-arm64.tar.gz

  # ===========================================================================
  # macOS x64 (Intel)
  # ===========================================================================
  build-darwin-amd64:
    runs-on: macos-13  # Intel runner
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install build dependencies
        run: |
          brew install nasm yasm automake autoconf libtool pkg-config

      - name: Build x264 static library
        run: |
          git clone --depth 1 --branch ${{ env.X264_VERSION }} https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --enable-static --disable-cli --prefix=$GITHUB_WORKSPACE/out
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build libvpx static library
        run: |
          git clone --depth 1 --branch ${{ env.LIBVPX_VERSION }} https://chromium.googlesource.com/webm/libvpx
          cd libvpx
          ./configure --enable-static --disable-shared --disable-examples --disable-tools --prefix=$GITHUB_WORKSPACE/out
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build opus static library
        run: |
          git clone --depth 1 --branch ${{ env.OPUS_VERSION }} https://gitlab.xiph.org/xiph/opus.git
          cd opus
          ./autogen.sh
          ./configure --enable-static --disable-shared --prefix=$GITHUB_WORKSPACE/out
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Package libraries
        run: |
          mkdir -p dist
          tar -czvf dist/codecs-darwin-amd64.tar.gz -C out .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: codecs-darwin-amd64
          path: dist/codecs-darwin-amd64.tar.gz

  # ===========================================================================
  # Linux x64
  # ===========================================================================
  build-linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm automake autoconf libtool pkg-config

      - name: Build x264 static library
        run: |
          git clone --depth 1 --branch ${{ env.X264_VERSION }} https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --enable-static --enable-pic --disable-cli --prefix=$GITHUB_WORKSPACE/out
          make -j$(nproc)
          make install

      - name: Build libvpx static library
        run: |
          git clone --depth 1 --branch ${{ env.LIBVPX_VERSION }} https://chromium.googlesource.com/webm/libvpx
          cd libvpx
          ./configure --enable-static --disable-shared --enable-pic --disable-examples --disable-tools --prefix=$GITHUB_WORKSPACE/out
          make -j$(nproc)
          make install

      - name: Build opus static library
        run: |
          git clone --depth 1 --branch ${{ env.OPUS_VERSION }} https://gitlab.xiph.org/xiph/opus.git
          cd opus
          ./autogen.sh
          ./configure --enable-static --disable-shared --with-pic --prefix=$GITHUB_WORKSPACE/out
          make -j$(nproc)
          make install

      - name: Package libraries
        run: |
          mkdir -p dist
          tar -czvf dist/codecs-linux-amd64.tar.gz -C out .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: codecs-linux-amd64
          path: dist/codecs-linux-amd64.tar.gz

  # ===========================================================================
  # Linux ARM64
  # ===========================================================================
  build-linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm automake autoconf libtool pkg-config

      - name: Build x264 static library
        run: |
          git clone --depth 1 --branch ${{ env.X264_VERSION }} https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --enable-static --enable-pic --disable-cli --prefix=$GITHUB_WORKSPACE/out
          make -j$(nproc)
          make install

      - name: Build libvpx static library
        run: |
          git clone --depth 1 --branch ${{ env.LIBVPX_VERSION }} https://chromium.googlesource.com/webm/libvpx
          cd libvpx
          ./configure --enable-static --disable-shared --enable-pic --disable-examples --disable-tools --prefix=$GITHUB_WORKSPACE/out
          make -j$(nproc)
          make install

      - name: Build opus static library
        run: |
          git clone --depth 1 --branch ${{ env.OPUS_VERSION }} https://gitlab.xiph.org/xiph/opus.git
          cd opus
          ./autogen.sh
          ./configure --enable-static --disable-shared --with-pic --prefix=$GITHUB_WORKSPACE/out
          make -j$(nproc)
          make install

      - name: Package libraries
        run: |
          mkdir -p dist
          tar -czvf dist/codecs-linux-arm64.tar.gz -C out .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: codecs-linux-arm64
          path: dist/codecs-linux-arm64.tar.gz

  # ===========================================================================
  # Windows x64 (using MSYS2)
  # ===========================================================================
  build-windows-amd64:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            autoconf
            automake
            libtool
            make
            git
            pkg-config

      - name: Build x264 static library
        run: |
          git clone --depth 1 --branch ${{ env.X264_VERSION }} https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --enable-static --disable-cli --prefix=$GITHUB_WORKSPACE/out --host=x86_64-w64-mingw32
          make -j$(nproc)
          make install

      - name: Build libvpx static library
        run: |
          git clone --depth 1 --branch ${{ env.LIBVPX_VERSION }} https://chromium.googlesource.com/webm/libvpx
          cd libvpx
          ./configure --enable-static --disable-shared --disable-examples --disable-tools --target=x86_64-win64-gcc --prefix=$GITHUB_WORKSPACE/out
          make -j$(nproc)
          make install

      - name: Build opus static library
        run: |
          git clone --depth 1 --branch ${{ env.OPUS_VERSION }} https://gitlab.xiph.org/xiph/opus.git
          cd opus
          ./autogen.sh
          ./configure --enable-static --disable-shared --prefix=$GITHUB_WORKSPACE/out --host=x86_64-w64-mingw32
          make -j$(nproc)
          make install

      - name: Package libraries
        run: |
          mkdir -p dist
          tar -czvf dist/codecs-windows-amd64.tar.gz -C out .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: codecs-windows-amd64
          path: dist/codecs-windows-amd64.tar.gz

  # ===========================================================================
  # Create Release with all artifacts
  # ===========================================================================
  release:
    needs:
      - build-darwin-arm64
      - build-darwin-amd64
      - build-linux-amd64
      - build-linux-arm64
      - build-windows-amd64
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/codecs-darwin-arm64/codecs-darwin-arm64.tar.gz
            artifacts/codecs-darwin-amd64/codecs-darwin-amd64.tar.gz
            artifacts/codecs-linux-amd64/codecs-linux-amd64.tar.gz
            artifacts/codecs-linux-arm64/codecs-linux-arm64.tar.gz
            artifacts/codecs-windows-amd64/codecs-windows-amd64.tar.gz

      - name: Create release from dispatch
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: codecs-${{ github.event.inputs.version }}
          name: Codec Libraries ${{ github.event.inputs.version }}
          body: |
            Pre-built static codec libraries for pion/mediadevices.

            ## Included Libraries
            - x264 (${{ env.X264_VERSION }})
            - libvpx (${{ env.LIBVPX_VERSION }})
            - opus (${{ env.OPUS_VERSION }})

            ## Usage
            ```bash
            go run ./cmd/codeccheck -install
            ```

            Or download manually and extract to your lib directory.
          files: |
            artifacts/codecs-darwin-arm64/codecs-darwin-arm64.tar.gz
            artifacts/codecs-darwin-amd64/codecs-darwin-amd64.tar.gz
            artifacts/codecs-linux-amd64/codecs-linux-amd64.tar.gz
            artifacts/codecs-linux-arm64/codecs-linux-arm64.tar.gz
            artifacts/codecs-windows-amd64/codecs-windows-amd64.tar.gz
