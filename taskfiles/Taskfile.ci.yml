# CI Tasks
#
# Tasks that are called by GitHub Actions workflows.
# Each ci:<name> task should have a matching .github/workflows/<name>.yml
#
# Validation: Run `task ci:validate` to check bindings
#
# This file is designed to be reusable across repos via Taskfile includes.

version: '3'

tasks:
  # ===========================================================================
  # Taskfile Validation (ci:taskfile)
  # ===========================================================================
  # Called by taskfile.yml workflow on push/PR
  # Runs cross-platform (Linux, macOS, Windows)

  taskfile:
    desc: Validate Taskfile works (used by CI matrix)
    cmds:
      - |
        echo "## Taskfile Validation"
        echo ""
        echo "OS: $(uname -s 2>/dev/null || echo Windows)"
        echo ""

      # Ensure dependencies are installed
      - echo "### Dependency Check"
      - task: :git:check:deps
      - task: :lanip:check:deps

      # Validate all included modules (check:validate pattern)
      - echo ""
      - echo "### Module Validation"
      - task: :git:check:validate
      - task: :lanip:check:validate

      # Validate workflow↔task bindings
      - echo ""
      - echo "### CI Binding Validation"
      - task: check:validate

      # Validate workflow dependencies
      - echo ""
      - echo "### Workflow Dependencies"
      - task: check:workflow-deps

      - |
        echo ""
        echo "### Include Test"
        echo "This task is loaded from: taskfiles/Taskfile.ci.yml"
        echo ""
        echo "### Variable Expansion Test"
        echo "PROJECT_NAME: {{.PROJECT_NAME}}"
        echo "DOMAIN: {{.DOMAIN}}"
        echo ""
        echo "Taskfile validated successfully"

  health:
    desc: Run all health checks (used by scheduled CI)
    cmds:
      - |
        echo "## Health Check"
        echo ""
        echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""

      - echo "### Module Health Checks"
      - task: :git:check:health
      - task: :lanip:check:health

      # Add more health checks as modules are added:
      # - task: :hugo:check:health
      # - task: :cf:check:health

      - echo ""
      - echo "### GitHub Secrets Check"
      - task: check:workflow-secrets

      - |
        echo ""
        echo "All health checks passed"

  health:test-fail:
    desc: "[TEST] Force health check failure to test notifications"
    cmds:
      - |
        echo "## Health Check (TEST FAILURE)"
        echo ""
        echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "This is an intentional failure to test the notification system."
        echo ""

      - task: :git:check:health:fail

  # ===========================================================================
  # Checks (check:* - diagnostics for this module)
  # ===========================================================================
  # validate      - verify workflow↔task bindings
  # workflow-status - show recent workflow runs

  check:validate:
    desc: Verify bidirectional binding between workflows and ci tasks
    cmds:
      - |
        echo "========================================"
        echo "CI Binding Validation"
        echo "========================================"
        ERRORS=0

        echo ""
        echo "1. Workflow → Task (workflows call valid tasks)"
        echo "----------------------------------------"
        for TASK_CALL in $(grep -h "task ci:" .github/workflows/*.yml 2>/dev/null | grep -oE "ci:[a-z_-]+" | sort -u); do
          if ! task --list 2>/dev/null | grep -q "^\* $TASK_CALL:"; then
            echo "ERROR: Workflow calls '$TASK_CALL' but task doesn't exist"
            ERRORS=$((ERRORS + 1))
          else
            echo "OK: $TASK_CALL"
          fi
        done

        echo ""
        echo "2. Task → Workflow (ci tasks have workflows)"
        echo "----------------------------------------"
        for TASK in $(task --list 2>/dev/null | grep "^\* ci:" | grep -v "ci:check:\|ci:health:test" | sed 's/\* \(ci:[a-z_-]*\):.*/\1/' | sort -u); do
          # ci:sitecheck → sitecheck.yml
          WORKFLOW_NAME=$(echo "$TASK" | sed 's/ci://')
          if [ ! -f ".github/workflows/${WORKFLOW_NAME}.yml" ]; then
            echo "ERROR: Task '$TASK' has no workflow .github/workflows/${WORKFLOW_NAME}.yml"
            ERRORS=$((ERRORS + 1))
          else
            echo "OK: $TASK → ${WORKFLOW_NAME}.yml"
          fi
        done

        echo ""
        echo "========================================"
        if [ $ERRORS -gt 0 ]; then
          echo "FAILED: $ERRORS error(s)"
          exit 1
        else
          echo "PASSED: All bindings valid"
        fi

  check:workflow-status:
    desc: Check recent workflow run status
    cmds:
      - |
        echo "## Recent Workflow Runs"
        echo ""
        gh run list --limit 5 --json name,status,conclusion,createdAt \
          --jq '.[] | "\(.name): \(.status) (\(.conclusion)) - \(.createdAt)"'

  check:workflow-secrets:
    desc: Verify required GitHub secrets are configured for workflows
    cmds:
      - |
        echo "========================================"
        echo "Workflow Secrets Check"
        echo "========================================"
        ERRORS=0

        # Get list of configured secrets
        echo ""
        echo "Checking GitHub secrets..."
        echo "----------------------------------------"

        # Collect required secrets from workflow comments
        # Pattern: "# Required secrets:" followed by "#   - SECRET_NAME"
        REQUIRED_SECRETS=""
        for WF in .github/workflows/*.yml; do
          [ -f "$WF" ] || continue
          WF_NAME=$(basename "$WF")

          # Extract secrets from "Required secrets:" block
          SECRETS=$(awk '/^# Required secrets:/{found=1; next} found && /^#   - /{gsub(/^#   - /, ""); gsub(/ .*/, ""); print} found && !/^#/{found=0}' "$WF")

          for SECRET in $SECRETS; do
            echo "  $WF_NAME requires: $SECRET"
            REQUIRED_SECRETS="$REQUIRED_SECRETS $SECRET"
          done
        done

        if [ -z "$REQUIRED_SECRETS" ]; then
          echo "  No secrets required by workflows"
          echo ""
          echo "========================================"
          echo "PASSED: No secrets to check"
          exit 0
        fi

        # Check if secrets exist in GitHub
        echo ""
        echo "Verifying secrets are configured..."
        echo "----------------------------------------"

        # Get configured secrets (requires gh CLI and repo access)
        if ! command -v gh >/dev/null 2>&1; then
          echo "SKIP: gh CLI not available"
          exit 0
        fi

        CONFIGURED=$(gh secret list --json name --jq '.[].name' 2>/dev/null || echo "")
        if [ -z "$CONFIGURED" ]; then
          echo "SKIP: Cannot list secrets (may need gh auth or repo permissions)"
          exit 0
        fi

        for SECRET in $(echo "$REQUIRED_SECRETS" | tr ' ' '\n' | sort -u); do
          [ -z "$SECRET" ] && continue
          if echo "$CONFIGURED" | grep -q "^${SECRET}$"; then
            echo "OK: $SECRET is configured"
          else
            echo "ERROR: $SECRET is NOT configured"
            echo "  → Add via: gh secret set $SECRET"
            ERRORS=$((ERRORS + 1))
          fi
        done

        echo ""
        echo "========================================"
        if [ $ERRORS -gt 0 ]; then
          echo "FAILED: $ERRORS secret(s) missing"
          exit 1
        else
          echo "PASSED: All secrets configured"
        fi

  check:workflow-deps:
    desc: Verify workflows have required dependencies based on taskfile REQUIRES
    cmds:
      - |
        echo "========================================"
        echo "Workflow Dependency Check"
        echo "========================================"
        ERRORS=0

        # Step 1: Collect requirements from all taskfiles
        echo ""
        echo "Module requirements (from REQUIRES comments):"
        echo "----------------------------------------"
        MODULES_NEED_GO=""
        MODULES_NEED_HUGO=""

        for TF in taskfiles/Taskfile.*.yml; do
          [ -f "$TF" ] || continue
          MODULE=$(basename "$TF" | sed 's/Taskfile\.\(.*\)\.yml/\1/')
          REQUIRES=$(grep "^# REQUIRES:" "$TF" 2>/dev/null | sed 's/# REQUIRES: //')

          if [ -n "$REQUIRES" ]; then
            echo "  $MODULE: $REQUIRES"
            if echo "$REQUIRES" | grep -q "go"; then
              MODULES_NEED_GO="$MODULES_NEED_GO $MODULE"
            fi
            if echo "$REQUIRES" | grep -q "hugo"; then
              MODULES_NEED_HUGO="$MODULES_NEED_HUGO hugo"
            fi
          fi
        done

        # Step 2: Check workflows that call Go-dependent tasks
        echo ""
        echo "Checking workflows..."
        echo "----------------------------------------"

        for WF in .github/workflows/*.yml; do
          [ -f "$WF" ] || continue
          WF_NAME=$(basename "$WF")
          NEEDS_GO=false

          # Check if workflow calls ci:taskfile or ci:health (which call Go modules)
          if grep -q "ci:taskfile\|ci:health\|ci:analytics\|ci:sitecheck" "$WF" 2>/dev/null; then
            NEEDS_GO=true
          fi

          if [ "$NEEDS_GO" = "true" ]; then
            if grep -q "setup-go" "$WF"; then
              echo "OK: $WF_NAME has Go"
            else
              echo "ERROR: $WF_NAME missing Go setup"
              ERRORS=$((ERRORS + 1))
            fi
          fi
        done

        echo ""
        echo "========================================"
        if [ $ERRORS -gt 0 ]; then
          echo "FAILED: $ERRORS error(s)"
          exit 1
        else
          echo "PASSED: All dependencies satisfied"
        fi
