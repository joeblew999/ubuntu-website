# FAA Airspace Data Sync Workflow
#
# Syncs FAA airspace data from ArcGIS to Cloudflare R2.
# Uses ETag tracking to only download changed files.
#
# Schedule: Weekly on Thursday (aligned with AIRAC cycle midpoint)
# Manual: workflow_dispatch for on-demand sync
#
# R2 Upload requires CLOUDFLARE_API_TOKEN secret with R2 permissions.

name: "[Sync] Airspace Data"

on:
  schedule:
    # Run weekly on Thursday at 06:00 UTC
    # AIRAC cycles are every 28 days; Thursday midweek catches most updates
    - cron: '0 6 * * 4'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force re-download all data'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.45.5
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Install tippecanoe
        run: |
          sudo apt-get update
          sudo apt-get install -y tippecanoe

      - name: Restore ETag cache
        uses: actions/cache@v4
        with:
          path: data/airspace/etags.json
          key: airspace-etags-${{ github.run_id }}
          restore-keys: |
            airspace-etags-

      - name: Sync FAA data
        run: |
          if [ "${{ inputs.force }}" = "true" ]; then
            echo "Force sync requested..."
            task airspace:sync:force
          else
            task airspace:sync
          fi

      - name: Convert to PMTiles
        run: |
          # Check if any GeoJSON files exist
          if [ -d "static/airspace" ] && [ "$(ls -A static/airspace/*.geojson 2>/dev/null)" ]; then
            echo "Converting GeoJSON to PMTiles..."
            task airspace:tile
            echo ""
            echo "Creating combined PMTiles..."
            task airspace:tile:combined
          else
            echo "No GeoJSON files to convert"
          fi

      - name: Update manifests
        run: |
          # Generate manifests with current timestamps and actual file sizes
          if [ -d "static/airspace/tiles" ] && [ "$(ls -A static/airspace/tiles/*.pmtiles 2>/dev/null)" ]; then
            echo "Updating manifests with current data..."
            task airspace:manifest:update
          else
            echo "No PMTiles - skipping manifest update"
          fi

      - name: Upload to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # Check if any PMTiles were created
          if [ -d "static/airspace/tiles" ] && [ "$(ls -A static/airspace/tiles/*.pmtiles 2>/dev/null)" ]; then
            echo "Uploading PMTiles to R2..."
            task r2:airspace:upload

            echo ""
            echo "Uploading manifests to R2..."
            wrangler r2 object put ubuntu-website-assets/airspace/manifest.json --file data/airspace/manifest.json --remote
            wrangler r2 object put ubuntu-website-assets/airspace/usa-manifest.json --file data/airspace/usa-manifest.json --remote
          else
            echo "No PMTiles to upload"
          fi

      - name: Save ETag cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/airspace/etags.json
          key: airspace-etags-${{ github.run_id }}

      - name: Summary
        run: |
          echo "## Airspace Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GeoJSON Files" >> $GITHUB_STEP_SUMMARY
          if [ -d "static/airspace" ]; then
            ls -lh static/airspace/*.geojson 2>/dev/null | while read line; do
              echo "- $line" >> $GITHUB_STEP_SUMMARY
            done
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PMTiles Files" >> $GITHUB_STEP_SUMMARY
          if [ -d "static/airspace/tiles" ]; then
            ls -lh static/airspace/tiles/*.pmtiles 2>/dev/null | while read line; do
              echo "- $line" >> $GITHUB_STEP_SUMMARY
            done
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ETag Status" >> $GITHUB_STEP_SUMMARY
          if [ -f "data/airspace/etags.json" ]; then
            cat data/airspace/etags.json >> $GITHUB_STEP_SUMMARY
          fi
