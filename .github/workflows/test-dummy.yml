# Test workflow for dummy tools FULL round-trip
# Tests BOTH CGO=0 and CGO=1 to validate xplat smart build:
#
# CGO=0 (dummy):     Linux builds ALL 6 platforms, macOS/Windows skip
# CGO=1 (dummy-cgo): macOS builds 2, Linux/Windows build 1 each (4 total)
#
# Full round-trip tested:
# 1. Build binaries (per platform matrix)
# 2. Upload artifacts
# 3. Create GitHub release (aggregated)
# 4. Download from release and verify
#
# Bootstrap: xplat embeds Task, so we only need to build xplat from source.
#
name: "Test: Dummy Round-Trip"

on:
  workflow_dispatch:
  push:
    paths:
      - 'cmd/dummy/**'
      - 'cmd/dummy-cgo/**'
      - 'cmd/xplat/**'
      - 'taskfiles/Taskfile.dummy*.yml'
      - 'taskfiles/toolchain/Taskfile.golang.yml'
      - 'taskfiles/tools/Taskfile.xplat.yml'
      - '.github/workflows/test-dummy.yml'

env:
  # Test release tag - includes run ID to avoid conflicts
  DUMMY_TEST_VERSION: v0.0.0-test-${{ github.run_id }}
  DUMMY_CGO_TEST_VERSION: v0.0.0-cgo-test-${{ github.run_id }}

jobs:
  # ===========================================================================
  # Test CGO=0 tool (dummy) - Linux builds all, others skip cross-compile
  # ===========================================================================
  test-cgo0:
    name: "CGO=0 (${{ matrix.os }})"
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      # Windows: Set HOME from USERPROFILE (Task's .HOME builtin needs it)
      - name: Set HOME on Windows
        if: runner.os == 'Windows'
        shell: bash
        run: echo "HOME=$USERPROFILE" >> $GITHUB_ENV

      # Build xplat with embedded Task
      - name: Build xplat (with embedded Task)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            mkdir -p "$HOME/bin"
            go build -o "$HOME/bin/xplat.exe" ./cmd/xplat
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            mkdir -p "$HOME/.local/bin"
            go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Verify xplat task
        shell: bash
        run: xplat task --version

      - name: Build dummy (dev)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml build

      - name: Release build
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:build

      - name: Test release binary
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:test

      # xplat smart build - Linux builds all 6, macOS/Windows skip
      - name: Cross-compile (xplat smart build)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:cross

      # Verify all 6 binaries built (Linux only)
      - name: Verify cross-compile output
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-* || echo "No binaries in .build/"
          for BINARY in dummy-linux-amd64 dummy-linux-arm64 dummy-darwin-amd64 dummy-darwin-arm64 dummy-windows-amd64.exe dummy-windows-arm64.exe; do
            if [ ! -f ".build/$BINARY" ]; then
              echo "ERROR: Missing .build/$BINARY"
              exit 1
            fi
          done
          echo "OK: All 6 platform binaries built (CGO=0 cross-compile works)"

      - name: Run dummy
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml run

      # Upload artifacts (Linux only - it built all 6)
      - name: Upload CGO=0 artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: dummy-binaries
          path: .build/dummy-*
          retention-days: 1

  # ===========================================================================
  # CGO=0 Release: Create test release from Linux artifacts
  # ===========================================================================
  release-cgo0:
    name: "CGO=0 Release"
    needs: test-cgo0
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4

      - name: Download CGO=0 artifacts
        uses: actions/download-artifact@v4
        with:
          name: dummy-binaries
          path: .build/

      - name: List artifacts
        run: ls -la .build/

      - name: Create test release
        run: |
          # Delete if exists from previous run
          gh release delete "dummy-${{ env.DUMMY_TEST_VERSION }}" --yes 2>/dev/null || true

          # Create release
          gh release create "dummy-${{ env.DUMMY_TEST_VERSION }}" \
            --title "Dummy Test Release ${{ env.DUMMY_TEST_VERSION }}" \
            --notes "Test release for CI validation. Will be deleted." \
            --prerelease \
            .build/dummy-*

  # ===========================================================================
  # CGO=0 Verify: Download from release and verify on each platform
  # ===========================================================================
  verify-cgo0:
    name: "CGO=0 Verify (${{ matrix.os }})"
    needs: release-cgo0
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            binary: dummy-linux-amd64
          - os: macos-latest
            binary: dummy-darwin-arm64
          - os: windows-latest
            binary: dummy-windows-amd64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download and verify binary
        shell: bash
        run: |
          URL="https://github.com/${{ github.repository }}/releases/download/dummy-${{ env.DUMMY_TEST_VERSION }}/${{ matrix.binary }}"
          echo "Downloading: $URL"
          curl -sL "$URL" -o dummy
          chmod +x dummy 2>/dev/null || true
          ./dummy
          echo "OK: Downloaded binary works!"

  # ===========================================================================
  # CGO=0 Cleanup: Delete test release
  # ===========================================================================
  cleanup-cgo0:
    name: "CGO=0 Cleanup"
    needs: verify-cgo0
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
      - name: Delete test release
        run: gh release delete "dummy-${{ env.DUMMY_TEST_VERSION }}" --yes --cleanup-tag 2>/dev/null || true

  # ===========================================================================
  # Test CGO=1 tool (dummy-cgo) - Each platform builds its own binaries
  # ===========================================================================
  test-cgo1:
    name: "CGO=1 (${{ matrix.os }})"
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set HOME on Windows
        if: runner.os == 'Windows'
        shell: bash
        run: echo "HOME=$USERPROFILE" >> $GITHUB_ENV

      - name: Build xplat (with embedded Task)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            mkdir -p "$HOME/bin"
            go build -o "$HOME/bin/xplat.exe" ./cmd/xplat
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            mkdir -p "$HOME/.local/bin"
            go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Verify xplat task
        shell: bash
        run: xplat task --version

      - name: Build dummy-cgo (dev)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml build

      - name: Release build
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml release:build

      - name: Test release binary
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml release:test

      # xplat smart build - each platform builds its own 2 binaries
      - name: Platform build (xplat smart build)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml release:cross

      # Verify platform-specific binaries built
      # CGO=1: Only macOS has universal toolchain, Linux/Windows CI lack arm64 cross-compiler
      - name: Verify platform build output (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-cgo-* || echo "No binaries in .build/"
          # Linux CI lacks arm64 cross-compiler, so only linux-amd64 is built
          if [ ! -f ".build/dummy-cgo-linux-amd64" ]; then
            echo "ERROR: Missing .build/dummy-cgo-linux-amd64"
            exit 1
          fi
          echo "OK: linux-amd64 binary built (CGO=1, native only)"

      - name: Verify platform build output (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-cgo-* || echo "No binaries in .build/"
          # Apple universal toolchain supports both arches
          for BINARY in dummy-cgo-darwin-amd64 dummy-cgo-darwin-arm64; do
            if [ ! -f ".build/$BINARY" ]; then
              echo "ERROR: Missing .build/$BINARY"
              exit 1
            fi
          done
          echo "OK: Both darwin binaries built (CGO=1, Apple universal toolchain)"

      - name: Verify platform build output (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-cgo-* || echo "No binaries in .build/"
          # Windows CI lacks arm64 cross-compiler, so only windows-amd64 is built
          if [ ! -f ".build/dummy-cgo-windows-amd64.exe" ]; then
            echo "ERROR: Missing .build/dummy-cgo-windows-amd64.exe"
            exit 1
          fi
          echo "OK: windows-amd64 binary built (CGO=1, native only)"

      - name: Run dummy-cgo
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml run

      # Upload platform-specific artifacts
      - name: Upload CGO=1 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dummy-cgo-${{ runner.os }}
          path: .build/dummy-cgo-*
          retention-days: 1

  # ===========================================================================
  # CGO=1 Release: Aggregate artifacts from all platforms, create release
  # ===========================================================================
  release-cgo1:
    name: "CGO=1 Release"
    needs: test-cgo1
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4

      # Download artifacts from all platforms
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: dummy-cgo-Linux
          path: .build/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: dummy-cgo-macOS
          path: .build/

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: dummy-cgo-Windows
          path: .build/

      - name: List all artifacts
        run: |
          echo "Aggregated binaries from all platforms:"
          ls -la .build/
          echo ""
          echo "Expected: linux-amd64, darwin-amd64, darwin-arm64, windows-amd64"

      - name: Create test release
        run: |
          # Delete if exists from previous run
          gh release delete "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" --yes 2>/dev/null || true

          # Create release with all platform binaries
          gh release create "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" \
            --title "Dummy-CGO Test Release ${{ env.DUMMY_CGO_TEST_VERSION }}" \
            --notes "CGO=1 test release for CI validation. Aggregated from 3 platforms. Will be deleted." \
            --prerelease \
            .build/dummy-cgo-*

  # ===========================================================================
  # CGO=1 Verify: Download from release and verify on each platform
  # ===========================================================================
  verify-cgo1:
    name: "CGO=1 Verify (${{ matrix.os }})"
    needs: release-cgo1
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            binary: dummy-cgo-linux-amd64
          - os: macos-latest
            binary: dummy-cgo-darwin-arm64
          - os: windows-latest
            binary: dummy-cgo-windows-amd64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download and verify binary
        shell: bash
        run: |
          URL="https://github.com/${{ github.repository }}/releases/download/dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}/${{ matrix.binary }}"
          echo "Downloading: $URL"
          curl -sL "$URL" -o dummy-cgo
          chmod +x dummy-cgo 2>/dev/null || true
          ./dummy-cgo
          echo "OK: Downloaded CGO=1 binary works!"

  # ===========================================================================
  # CGO=1 Cleanup: Delete test release
  # ===========================================================================
  cleanup-cgo1:
    name: "CGO=1 Cleanup"
    needs: verify-cgo1
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
      - name: Delete test release
        run: gh release delete "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" --yes --cleanup-tag 2>/dev/null || true
