# gh - GitHub CLI Taskfile
#
# Wraps gh CLI for common GitHub operations.
# Works both locally and in CI (gh is pre-installed in GitHub Actions).
#
# REQUIRES: gh (GitHub CLI)
#
# Pattern: All tool taskfiles define TOOL_BIN with {{exeExt}} for Windows support

version: '3'

vars:
  # Binary name with platform-specific extension (.exe on Windows)
  GH_BIN: 'gh{{exeExt}}'

tasks:
  # ===========================================================================
  # Checks
  # ===========================================================================

  check:deps:
    desc: Ensure gh CLI is installed and authenticated
    run: once
    cmds:
      - |
        if ! command -v {{.GH_BIN}} >/dev/null 2>&1; then
          echo "ERROR: {{.GH_BIN}} not found"
          echo "Install: https://cli.github.com/"
          exit 1
        fi
        echo "OK: {{.GH_BIN}} $({{.GH_BIN}} --version | head -1 | cut -d' ' -f3)"

        # Check auth (skip in CI - uses GITHUB_TOKEN automatically)
        if [ -z "$GITHUB_ACTIONS" ]; then
          if ! {{.GH_BIN}} auth status >/dev/null 2>&1; then
            echo "WARN: gh not authenticated. Run: gh auth login"
          else
            echo "OK: gh authenticated"
          fi
        else
          echo "OK: Running in GitHub Actions (uses GITHUB_TOKEN)"
        fi

  # ===========================================================================
  # Releases
  # ===========================================================================

  release:list:
    desc: List recent releases
    cmds:
      - '{{.GH_BIN}} release list --limit 10'

  release:view:
    desc: View latest release details
    cmds:
      - '{{.GH_BIN}} release view'

  release:create:
    desc: Create a release (usage - task gh:release:create -- TAG)
    cmds:
      - |
        TAG="{{.CLI_ARGS}}"
        if [ -z "$TAG" ]; then
          echo "Usage: task gh:release:create -- TAG"
          echo "Example: task gh:release:create -- v1.0.0"
          exit 1
        fi
        {{.GH_BIN}} release create "$TAG" --generate-notes

  release:create-with-assets:
    desc: Create release with assets (usage - task gh:release:create-with-assets -- TAG FILE1 FILE2...)
    cmds:
      - |
        ARGS="{{.CLI_ARGS}}"
        TAG=$(echo "$ARGS" | cut -d' ' -f1)
        FILES=$(echo "$ARGS" | cut -d' ' -f2-)

        if [ -z "$TAG" ] || [ "$TAG" = "$FILES" ]; then
          echo "Usage: task gh:release:create-with-assets -- TAG FILE1 [FILE2...]"
          echo "Example: task gh:release:create-with-assets -- v1.0.0 dist/*"
          exit 1
        fi

        {{.GH_BIN}} release create "$TAG" --generate-notes $FILES

  release:upload:
    desc: Upload assets to existing release (usage - task gh:release:upload -- TAG FILE1 FILE2...)
    cmds:
      - |
        ARGS="{{.CLI_ARGS}}"
        TAG=$(echo "$ARGS" | cut -d' ' -f1)
        FILES=$(echo "$ARGS" | cut -d' ' -f2-)

        if [ -z "$TAG" ] || [ "$TAG" = "$FILES" ]; then
          echo "Usage: task gh:release:upload -- TAG FILE1 [FILE2...]"
          exit 1
        fi

        {{.GH_BIN}} release upload "$TAG" $FILES --clobber

  release:delete:
    desc: Delete a release (usage - task gh:release:delete -- TAG)
    cmds:
      - |
        TAG="{{.CLI_ARGS}}"
        if [ -z "$TAG" ]; then
          echo "Usage: task gh:release:delete -- TAG"
          exit 1
        fi
        {{.GH_BIN}} release delete "$TAG" --yes --cleanup-tag

  # ===========================================================================
  # Workflows & Runs
  # ===========================================================================

  workflow:list:
    desc: List workflows
    cmds:
      - '{{.GH_BIN}} workflow list'

  workflow:run:
    desc: Trigger a workflow (usage - task gh:workflow:run -- WORKFLOW)
    cmds:
      - |
        WORKFLOW="{{.CLI_ARGS}}"
        if [ -z "$WORKFLOW" ]; then
          echo "Usage: task gh:workflow:run -- WORKFLOW"
          echo "Example: task gh:workflow:run -- xplat.yml"
          exit 1
        fi
        {{.GH_BIN}} workflow run "$WORKFLOW"
        echo "Triggered workflow: $WORKFLOW"

  run:list:
    desc: List recent workflow runs
    cmds:
      - '{{.GH_BIN}} run list --limit 10'

  run:watch:
    desc: Watch latest run until completion
    cmds:
      - '{{.GH_BIN}} run watch'

  run:view:
    desc: View latest run details
    cmds:
      - '{{.GH_BIN}} run view'

  run:failed:
    desc: Show failed runs
    cmds:
      - '{{.GH_BIN}} run list --status failure --limit 5'

  run:logs:
    desc: View logs for latest run
    cmds:
      - '{{.GH_BIN}} run view --log'

  run:delete:
    desc: Delete a workflow run (usage - task gh:run:delete -- RUN_ID)
    cmds:
      - |
        RUN_ID="{{.CLI_ARGS}}"
        if [ -z "$RUN_ID" ]; then
          echo "Usage: task tools:gh:run:delete -- RUN_ID"
          echo "Get RUN_ID from: task tools:gh:run:list"
          exit 1
        fi
        {{.GH_BIN}} run delete "$RUN_ID" --yes
        echo "Deleted run: $RUN_ID"

  run:delete-failed:
    desc: Delete all failed workflow runs
    cmds:
      - |
        echo "Deleting failed workflow runs..."
        FAILED_RUNS=$({{.GH_BIN}} run list --status failure --json databaseId --jq '.[].databaseId')
        if [ -z "$FAILED_RUNS" ]; then
          echo "No failed runs to delete"
          exit 0
        fi
        COUNT=0
        for RUN_ID in $FAILED_RUNS; do
          {{.GH_BIN}} run delete "$RUN_ID" --yes 2>/dev/null || true
          COUNT=$((COUNT + 1))
        done
        echo "Deleted $COUNT failed runs"

  run:cleanup:
    desc: Delete old workflow runs (keeps last 10 per workflow)
    cmds:
      - |
        echo "Cleaning up old workflow runs..."
        echo ""

        # Get workflow IDs (more reliable than names with special chars)
        {{.GH_BIN}} workflow list --json id,name | jq -r '.[] | "\(.id) \(.name)"' | while read -r ID NAME; do
          echo "Processing: $NAME (id: $ID)"
          # Get runs older than the 10 most recent
          RUNS=$({{.GH_BIN}} run list --workflow "$ID" --json databaseId --jq '.[10:] | .[].databaseId' 2>/dev/null)

          if [ -n "$RUNS" ]; then
            for RUN_ID in $RUNS; do
              {{.GH_BIN}} run delete "$RUN_ID" --yes 2>/dev/null || true
            done
            echo "  Cleaned up old runs"
          else
            echo "  No old runs to clean"
          fi
        done
        echo ""
        echo "Cleanup complete"

  # ===========================================================================
  # PRs & Issues
  # ===========================================================================

  pr:list:
    desc: List open pull requests
    cmds:
      - '{{.GH_BIN}} pr list'

  pr:create:
    desc: Create PR from current branch
    cmds:
      - '{{.GH_BIN}} pr create --fill'

  pr:view:
    desc: View current PR
    cmds:
      - '{{.GH_BIN}} pr view'

  pr:checks:
    desc: View PR check status
    cmds:
      - '{{.GH_BIN}} pr checks'

  issue:list:
    desc: List open issues
    cmds:
      - '{{.GH_BIN}} issue list'

  # ===========================================================================
  # Repository
  # ===========================================================================

  repo:view:
    desc: View repository info
    cmds:
      - '{{.GH_BIN}} repo view'

  repo:clone:
    desc: Clone a repository (usage - task gh:repo:clone -- REPO)
    cmds:
      - |
        REPO="{{.CLI_ARGS}}"
        if [ -z "$REPO" ]; then
          echo "Usage: task gh:repo:clone -- OWNER/REPO"
          exit 1
        fi
        {{.GH_BIN}} repo clone "$REPO"

  # ===========================================================================
  # API (raw access)
  # ===========================================================================

  api:
    desc: Make raw API call (usage - task gh:api -- ENDPOINT)
    cmds:
      - |
        ENDPOINT="{{.CLI_ARGS}}"
        if [ -z "$ENDPOINT" ]; then
          echo "Usage: task gh:api -- ENDPOINT"
          echo "Example: task gh:api -- repos/{owner}/{repo}/releases"
          exit 1
        fi
        {{.GH_BIN}} api "$ENDPOINT"

  # ===========================================================================
  # Repository Secrets & Variables
  # ===========================================================================
  # Secrets: Encrypted, for sensitive values (API tokens)
  # Variables: Plain text, for non-sensitive config (account IDs, URLs)

  secret:list:
    desc: List GitHub repository secrets
    cmds:
      - '{{.GH_BIN}} secret list'

  secret:set:
    desc: Set a GitHub repository secret (e.g., task tools:gh:secret:set -- CLOUDFLARE_API_TOKEN)
    cmds:
      - '{{.GH_BIN}} secret set {{.CLI_ARGS}}'

  var:list:
    desc: List GitHub repository variables
    cmds:
      - '{{.GH_BIN}} variable list'

  var:set:
    desc: Set a GitHub repository variable (e.g., task tools:gh:var:set -- CF_ACCOUNT_ID value)
    cmds:
      - '{{.GH_BIN}} variable set {{.CLI_ARGS}}'

  var:sync:
    desc: Sync repository variables from Taskfile values
    cmds:
      - |
        echo "Syncing GitHub repository variables..."
        echo ""
        echo "Setting CF_ACCOUNT_ID={{.CF_ACCOUNT_ID}}"
        {{.GH_BIN}} variable set CF_ACCOUNT_ID --body "{{.CF_ACCOUNT_ID}}"
        echo "Setting CF_WEB_ANALYTICS_SITE_TAG={{.CF_WEB_ANALYTICS_SITE_TAG}}"
        {{.GH_BIN}} variable set CF_WEB_ANALYTICS_SITE_TAG --body "{{.CF_WEB_ANALYTICS_SITE_TAG}}"
        echo "Setting SITE_URL={{.URL_PRODUCTION}}"
        {{.GH_BIN}} variable set SITE_URL --body "{{.URL_PRODUCTION}}"
        echo ""
        echo "Variables synced. Verify with: task tools:gh:var:list"
