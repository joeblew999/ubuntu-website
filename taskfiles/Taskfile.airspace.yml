# Airspace Pipeline - FAA data sync and tile generation
#
# All logic is in Go: cmd/airspace + internal/airspace
#
# Usage:
#   task airspace:pipeline              - Full idempotent pipeline
#   task airspace:pipeline FORCE=true   - Force re-download and regenerate
#   task airspace:pipeline TILER=gotiler - Use pure Go tiler
#   task airspace:status                - Show current data status

version: '3'

vars:
  FORCE: 'false'
  TILER: 'auto'  # auto, tippecanoe, gotiler

tasks:
  # Primary pipeline command
  pipeline:
    desc: Full idempotent pipeline (sync → tile → manifest)
    vars:
      FORCE_FLAG: '{{if eq .FORCE "true"}}-force{{end}}'
      TILER_FLAG: '{{if ne .TILER "auto"}}-tiler {{.TILER}}{{end}}'
    cmds:
      - go run ./cmd/airspace pipeline {{.FORCE_FLAG}} {{.TILER_FLAG}}

  # Pipeline + R2 upload
  pipeline:upload:
    desc: Pipeline + R2 upload (only uploads if changes)
    vars:
      FORCE_FLAG: '{{if eq .FORCE "true"}}-force{{end}}'
      TILER_FLAG: '{{if ne .TILER "auto"}}-tiler {{.TILER}}{{end}}'
    cmds:
      - go run ./cmd/airspace pipeline {{.FORCE_FLAG}} {{.TILER_FLAG}}
      - |
        if [ -f "data/airspace/sync_result.json" ]; then
          HAS_CHANGES=$(jq -r '.has_changes' data/airspace/sync_result.json)
          if [ "$HAS_CHANGES" = "true" ]; then
            echo "Uploading to R2..."
            task r2:airspace:upload
          else
            echo "No changes - skipping R2 upload"
          fi
        fi

  # Individual commands
  sync:
    desc: Sync FAA data (ETag-based change detection)
    vars:
      FORCE_FLAG: '{{if eq .FORCE "true"}}-force{{end}}'
    cmds:
      - go run ./cmd/airspace sync {{.FORCE_FLAG}}

  tile:
    desc: Convert GeoJSON to PMTiles
    vars:
      FORCE_FLAG: '{{if eq .FORCE "true"}}-force{{end}}'
      TILER_FLAG: '{{if ne .TILER "auto"}}-tiler {{.TILER}}{{end}}'
      DATASET_FLAG: '{{if .DATASET}}-dataset {{.DATASET}}{{end}}'
    cmds:
      - go run ./cmd/airspace tile {{.FORCE_FLAG}} {{.TILER_FLAG}} {{.DATASET_FLAG}}

  manifest:
    desc: Generate manifest files
    cmds:
      - go run ./cmd/airspace manifest

  # Status and debugging
  status:
    desc: Show data file status
    cmds:
      - go run ./cmd/airspace status

  history:
    desc: Show sync history (for cron tuning)
    cmds:
      - go run ./cmd/airspace history

  # CI helpers
  check:
    desc: Check if sync had changes (for CI)
    cmds:
      - go run ./cmd/airspace check

  summary:
    desc: Generate markdown summary (for CI)
    cmds:
      - go run ./cmd/airspace summary

  # Tool installation
  install:tippecanoe:
    desc: Install tippecanoe (optional - gotiler works without it)
    status:
      - which tippecanoe
    cmds:
      - |
        case "$(uname)" in
          Darwin) brew install tippecanoe ;;
          Linux) sudo apt-get update && sudo apt-get install -y tippecanoe ;;
        esac

  # Demo
  open:
    desc: Open airspace demo in browser
    cmds:
      - open http://localhost:1313/fleet/airspace-demo/
