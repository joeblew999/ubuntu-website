# Airspace Demo Tasks
#
# Interactive map showing FAA airspace data for BVLOS development.
# Serves as demo/proof-of-capability for data provider applications.
#
# Usage:
#   task airspace:open      - Open demo in browser (via Hugo dev server)
#   task airspace:download  - Refresh FAA data
#
# The demo is a Hugo page at /airspace-demo/ - run `task dev` first.
# Data URL (R2) is configured in config/_default/params.toml

version: '3'

vars:
  AIRSPACE_DATA_DIR: static/airspace

tasks:
  # ===========================================================================
  # Demo Access
  # ===========================================================================

  open:
    desc: Open airspace demo in browser (requires Hugo dev server)
    cmds:
      - open http://localhost:1313/airspace-demo/

  # ===========================================================================
  # Data Management
  # ===========================================================================

  download:
    desc: Download/refresh FAA airspace data
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}}

  download:uas:
    desc: Download only UAS Facility Map (LAANC)
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}} -dataset uas

  download:boundary:
    desc: Download only Airspace Boundary
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}} -dataset boundary

  download:sua:
    desc: Download only Special Use Airspace
    cmds:
      - go run ./cmd/airspace download -output {{.AIRSPACE_DATA_DIR}} -dataset sua

  status:
    desc: Show airspace data status
    cmds:
      - go run ./cmd/airspace status -output {{.AIRSPACE_DATA_DIR}}

  # ===========================================================================
  # Checks
  # ===========================================================================

  check:deps:
    desc: Check airspace data and R2 config
    cmds:
      - |
        echo "Checking airspace setup..."

        # Check R2 config in params.toml
        if grep -q "r2.public_url" config/_default/params.toml 2>/dev/null; then
          echo "OK: R2 URL configured in params.toml"
        else
          echo "WARNING: R2 URL not found in params.toml"
        fi

        # Check Hugo layout
        if [ -f "layouts/fleet/airspace-demo.html" ]; then
          echo "OK: Hugo layout exists"
        else
          echo "ERROR: Missing layouts/fleet/airspace-demo.html"
          exit 1
        fi

        # Check local data (for downloads)
        if [ -d "{{.AIRSPACE_DATA_DIR}}" ]; then
          echo "OK: Local data present at {{.AIRSPACE_DATA_DIR}}"
        else
          echo "INFO: No local data. Run: task airspace:download"
        fi
