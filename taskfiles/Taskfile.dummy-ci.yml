# Dummy Tool CI Taskfile
# Self-contained taskfile for CI testing - includes only what's needed
#
# Usage in workflow: task -t taskfiles/Taskfile.dummy-ci.yml <task>
# IMPORTANT: Run from repo root, not from taskfiles/ directory
#
# Notes on Task variables:
#   ROOT_DIR = directory of the -t taskfile (taskfiles/)
#   USER_WORKING_DIR = directory where task was invoked (repo root)
#   TASKFILE_DIR = directory of current taskfile (for included: their dir)
#
version: '3'

includes:
  toolchain:golang:
    taskfile: ./toolchain/Taskfile.golang.yml
  tools:xplat:
    taskfile: ./tools/Taskfile.xplat.yml

vars:
  # Core paths - always use absolute HOME-based paths
  BIN_INSTALL_DIR: '{{if eq OS "windows"}}{{.HOME}}/bin{{else}}{{.HOME}}/.local/bin{{end}}'
  XPLAT_BIN: '{{.BIN_INSTALL_DIR}}/xplat{{exeExt}}'

  # Dummy tool config
  DUMMY_VERSION: v0.0.1
  DUMMY_REPO: joeblew999/ubuntu-website
  DUMMY_BIN: 'dummy{{exeExt}}'
  DUMMY_CGO: '0'

tasks:
  # ===========================================================================
  # Setup - Build xplat first
  # ===========================================================================

  setup:
    desc: Build xplat and add to PATH (run first)
    cmds:
      - task: tools:xplat:check:deps

  # ===========================================================================
  # Dummy tasks
  # ===========================================================================

  check:deps:
    desc: Ensure dummy binary is available
    status:
      - test -f "{{.BIN_INSTALL_DIR}}/{{.DUMMY_BIN}}"
    cmds:
      - '{{.XPLAT_BIN}} binary install dummy {{.DUMMY_VERSION}} {{.DUMMY_REPO}} --source "{{toSlash .USER_WORKING_DIR}}/cmd/dummy"'

  run:
    desc: Run the dummy binary
    deps: [check:deps]
    cmds:
      - '"{{.BIN_INSTALL_DIR}}/{{.DUMMY_BIN}}"'

  build:
    desc: Build dummy binary locally
    vars:
      TARGET_OS: '{{if env "GOOS"}}{{env "GOOS"}}{{else}}{{OS}}{{end}}'
      TARGET_ARCH: '{{if env "GOARCH"}}{{env "GOARCH"}}{{else}}{{ARCH}}{{end}}'
      EXT: '{{if eq .TARGET_OS "windows"}}.exe{{end}}'
      BIN_BASE: '{{trimSuffix ".exe" .DUMMY_BIN}}'
      BUILD_DIR: '{{.USER_WORKING_DIR}}/.build'
      OUTPUT: '{{.BUILD_DIR}}/{{.BIN_BASE}}-{{.TARGET_OS}}-{{.TARGET_ARCH}}{{.EXT}}'
    cmds:
      - mkdir -p "{{.BUILD_DIR}}"
      - |
        echo "Building {{.BIN_BASE}} dev for {{.TARGET_OS}}/{{.TARGET_ARCH}} (CGO={{.DUMMY_CGO}})..."
        CGO_ENABLED={{.DUMMY_CGO}} GOWORK=off \
        GOOS={{.TARGET_OS}} GOARCH={{.TARGET_ARCH}} \
        go build -ldflags="-s -w -X main.version=dev" \
        -o "{{.OUTPUT}}" "{{toSlash .USER_WORKING_DIR}}/cmd/dummy"
        echo "Output: {{.OUTPUT}}"

  release:build:
    desc: Build dummy for release (current platform, or set GOOS/GOARCH)
    vars:
      TARGET_OS: '{{if env "GOOS"}}{{env "GOOS"}}{{else}}{{OS}}{{end}}'
      TARGET_ARCH: '{{if env "GOARCH"}}{{env "GOARCH"}}{{else}}{{ARCH}}{{end}}'
      EXT: '{{if eq .TARGET_OS "windows"}}.exe{{end}}'
      BIN_BASE: '{{trimSuffix ".exe" .DUMMY_BIN}}'
      VERSION: '{{.RELEASE_VERSION | default .DUMMY_VERSION}}'
      BUILD_DIR: '{{.USER_WORKING_DIR}}/.build'
      OUTPUT: '{{.BUILD_DIR}}/{{.BIN_BASE}}-{{.TARGET_OS}}-{{.TARGET_ARCH}}{{.EXT}}'
    cmds:
      - mkdir -p "{{.BUILD_DIR}}"
      - |
        echo "Building {{.BIN_BASE}} {{.VERSION}} for {{.TARGET_OS}}/{{.TARGET_ARCH}} (CGO={{.DUMMY_CGO}})..."
        CGO_ENABLED={{.DUMMY_CGO}} GOWORK=off \
        GOOS={{.TARGET_OS}} GOARCH={{.TARGET_ARCH}} \
        go build -ldflags="-s -w -X main.version={{.VERSION}}" \
        -o "{{.OUTPUT}}" "{{toSlash .USER_WORKING_DIR}}/cmd/dummy"
        echo "Output: {{.OUTPUT}}"

  release:test:
    desc: Test built dummy binary
    vars:
      TARGET_OS: '{{if env "GOOS"}}{{env "GOOS"}}{{else}}{{OS}}{{end}}'
      TARGET_ARCH: '{{if env "GOARCH"}}{{env "GOARCH"}}{{else}}{{ARCH}}{{end}}'
      EXT: '{{if eq .TARGET_OS "windows"}}.exe{{end}}'
      BIN_BASE: '{{trimSuffix ".exe" .DUMMY_BIN}}'
      BUILD_DIR: '{{.USER_WORKING_DIR}}/.build'
      BINARY: '{{.BUILD_DIR}}/{{.BIN_BASE}}-{{.TARGET_OS}}-{{.TARGET_ARCH}}{{.EXT}}'
    cmds:
      - |
        echo "Testing {{.BIN_BASE}}..."
        if [ ! -f "{{.BINARY}}" ]; then
          echo "ERROR: Binary not found: {{.BINARY}}"
          exit 1
        fi
        chmod +x "{{.BINARY}}" 2>/dev/null || true
        "{{.BINARY}}" -version
        echo "OK: {{.BIN_BASE}} binary works"

  release:cross:
    desc: Cross-compile for all platforms (CGO=0 only)
    cmds:
      - '{{.XPLAT_BIN}} release build dummy'
