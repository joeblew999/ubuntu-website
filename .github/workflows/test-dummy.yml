# Test workflow for dummy tool round-trip
# Uses 3-platform matrix, but xplat is smart about what to build:
# - CGO=0: Linux builds ALL platforms, macOS/Windows skip
# - CGO=1: Each platform builds its own binaries
#
# Uses self-contained CI Taskfile for isolation
# IMPORTANT: Run from repo root so ROOT_DIR is correct
#
# Bootstrap: xplat embeds Task, so we only need to build xplat from source.
# No separate Task installation required!
#
name: "Test: Dummy Round-Trip"

on:
  workflow_dispatch:
  push:
    paths:
      - 'cmd/dummy/**'
      - 'cmd/xplat/**'
      - 'taskfiles/Taskfile.dummy.yml'
      - 'taskfiles/Taskfile.dummy-ci.yml'
      - 'taskfiles/toolchain/Taskfile.golang.yml'
      - 'taskfiles/tools/Taskfile.xplat.yml'
      - '.github/workflows/test-dummy.yml'

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      # Windows: Set HOME from USERPROFILE (Task's .HOME builtin needs it)
      - name: Set HOME on Windows
        if: runner.os == 'Windows'
        shell: bash
        run: echo "HOME=$USERPROFILE" >> $GITHUB_ENV

      # Build xplat with embedded Task - this is the only bootstrap step needed!
      # xplat includes Task, so no separate Task installation required.
      - name: Build xplat (with embedded Task)
        shell: bash
        run: |
          mkdir -p "$HOME/.local/bin"
          if [ "$RUNNER_OS" == "Windows" ]; then
            go build -o "$HOME/bin/xplat.exe" ./cmd/xplat
          else
            go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
          fi

      - name: Add bin to PATH
        shell: bash
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/bin" >> $GITHUB_PATH

      # Verify xplat task works
      - name: Verify xplat task
        run: xplat task --version

      # All subsequent steps use "xplat task" instead of "task"
      - name: Build dummy
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml build

      - name: Release build
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:build

      - name: Test release binary
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:test

      # xplat smart build - skips on non-Linux for CGO=0
      - name: Cross-compile (xplat smart build)
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:cross

      # Verify all binaries built (Linux only)
      - name: Verify cross-compile output
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-* || echo "No binaries in .build/"
          for BINARY in dummy-linux-amd64 dummy-linux-arm64 dummy-darwin-amd64 dummy-darwin-arm64 dummy-windows-amd64.exe dummy-windows-arm64.exe; do
            if [ ! -f ".build/$BINARY" ]; then
              echo "ERROR: Missing .build/$BINARY"
              exit 1
            fi
          done
          echo "OK: All 6 platform binaries built"

      - name: Clean and test check:deps
        shell: bash
        run: |
          rm -f ~/.local/bin/dummy 2>/dev/null || true
          rm -f ~/bin/dummy.exe 2>/dev/null || true
          xplat task -t taskfiles/Taskfile.dummy-ci.yml check:deps

      - name: Run dummy
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml run

      - name: Verify output
        shell: bash
        run: |
          OUTPUT=$(xplat task -t taskfiles/Taskfile.dummy-ci.yml run 2>&1 | tail -1)
          echo "Output: $OUTPUT"
          if [ "$OUTPUT" != "dev" ]; then
            echo "ERROR: Expected 'dev', got '$OUTPUT'"
            exit 1
          fi
          echo "OK: dummy outputs correct version"
