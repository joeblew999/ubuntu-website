# Test workflow for dummy tools round-trip
# Tests BOTH CGO=0 and CGO=1 to validate xplat smart build:
#
# CGO=0 (dummy):     Linux builds ALL 6 platforms, macOS/Windows skip
# CGO=1 (dummy-cgo): Each platform builds its own 2 binaries
#
# Bootstrap: xplat embeds Task, so we only need to build xplat from source.
# No separate Task installation required!
#
name: "Test: Dummy Round-Trip"

on:
  workflow_dispatch:
  push:
    paths:
      - 'cmd/dummy/**'
      - 'cmd/dummy-cgo/**'
      - 'cmd/xplat/**'
      - 'taskfiles/Taskfile.dummy*.yml'
      - 'taskfiles/toolchain/Taskfile.golang.yml'
      - 'taskfiles/tools/Taskfile.xplat.yml'
      - '.github/workflows/test-dummy.yml'

jobs:
  # ===========================================================================
  # Test CGO=0 tool (dummy) - Linux builds all, others skip cross-compile
  # ===========================================================================
  test-cgo0:
    name: "CGO=0 (${{ matrix.os }})"
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      # Windows: Set HOME from USERPROFILE (Task's .HOME builtin needs it)
      - name: Set HOME on Windows
        if: runner.os == 'Windows'
        shell: bash
        run: echo "HOME=$USERPROFILE" >> $GITHUB_ENV

      # Build xplat with embedded Task
      - name: Build xplat (with embedded Task)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            mkdir -p "$HOME/bin"
            go build -o "$HOME/bin/xplat.exe" ./cmd/xplat
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            mkdir -p "$HOME/.local/bin"
            go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Verify xplat task
        shell: bash
        run: xplat task --version

      - name: Build dummy (dev)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml build

      - name: Release build
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:build

      - name: Test release binary
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:test

      # xplat smart build - Linux builds all 6, macOS/Windows skip
      - name: Cross-compile (xplat smart build)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml release:cross

      # Verify all 6 binaries built (Linux only)
      - name: Verify cross-compile output
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-* || echo "No binaries in .build/"
          for BINARY in dummy-linux-amd64 dummy-linux-arm64 dummy-darwin-amd64 dummy-darwin-arm64 dummy-windows-amd64.exe dummy-windows-arm64.exe; do
            if [ ! -f ".build/$BINARY" ]; then
              echo "ERROR: Missing .build/$BINARY"
              exit 1
            fi
          done
          echo "OK: All 6 platform binaries built (CGO=0 cross-compile works)"

      - name: Run dummy
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-ci.yml run

  # ===========================================================================
  # Test CGO=1 tool (dummy-cgo) - Each platform builds its own binaries
  # ===========================================================================
  test-cgo1:
    name: "CGO=1 (${{ matrix.os }})"
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set HOME on Windows
        if: runner.os == 'Windows'
        shell: bash
        run: echo "HOME=$USERPROFILE" >> $GITHUB_ENV

      - name: Build xplat (with embedded Task)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            mkdir -p "$HOME/bin"
            go build -o "$HOME/bin/xplat.exe" ./cmd/xplat
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            mkdir -p "$HOME/.local/bin"
            go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Verify xplat task
        shell: bash
        run: xplat task --version

      - name: Build dummy-cgo (dev)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml build

      - name: Release build
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml release:build

      - name: Test release binary
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml release:test

      # xplat smart build - each platform builds its own 2 binaries
      - name: Platform build (xplat smart build)
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml release:cross

      # Verify platform-specific binaries built
      # CGO=1: macOS/Windows toolchains support both arches, Linux CI only has native
      - name: Verify platform build output (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-cgo-* || echo "No binaries in .build/"
          # Linux CI lacks arm64 cross-compiler, so only linux-amd64 is built
          if [ ! -f ".build/dummy-cgo-linux-amd64" ]; then
            echo "ERROR: Missing .build/dummy-cgo-linux-amd64"
            exit 1
          fi
          echo "OK: linux-amd64 binary built (CGO=1, Linux CI native only)"

      - name: Verify platform build output (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-cgo-* || echo "No binaries in .build/"
          # Apple toolchain supports both arches
          for BINARY in dummy-cgo-darwin-amd64 dummy-cgo-darwin-arm64; do
            if [ ! -f ".build/$BINARY" ]; then
              echo "ERROR: Missing .build/$BINARY"
              exit 1
            fi
          done
          echo "OK: Both darwin binaries built (CGO=1, Apple toolchain)"

      - name: Verify platform build output (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-cgo-* || echo "No binaries in .build/"
          # Windows toolchain supports both arches
          for BINARY in dummy-cgo-windows-amd64.exe dummy-cgo-windows-arm64.exe; do
            if [ ! -f ".build/$BINARY" ]; then
              echo "ERROR: Missing .build/$BINARY"
              exit 1
            fi
          done
          echo "OK: Both windows binaries built (CGO=1, Windows toolchain)"

      - name: Run dummy-cgo
        shell: bash
        run: xplat task -t taskfiles/Taskfile.dummy-cgo-ci.yml run
