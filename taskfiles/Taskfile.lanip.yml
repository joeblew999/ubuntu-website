# LAN IP Tasks
#
# Cross-platform LAN IP detection using Go.
# Works on macOS, Linux, Windows.
#
# REQUIRES: go (for go run ./cmd/lanip)

version: '3'

tasks:
  # ===========================================================================
  # Checks (check:* - diagnostics for this module)
  # ===========================================================================
  # deps     - ensure required tools are installed
  # validate - smoke test, runs in CI on change
  # health   - external system check (network reachability)

  check:deps:
    desc: Ensure Go is installed (installs if missing)
    cmds:
      - |
        if command -v go >/dev/null 2>&1; then
          echo "OK: go $(go version | cut -d' ' -f3)"
          exit 0
        fi

        echo "Installing Go..."

        # Detect OS and install
        case "$(uname -s)" in
          Darwin)
            if command -v brew >/dev/null 2>&1; then
              brew install go
            else
              echo "ERROR: brew not found. Install from https://go.dev/dl/"
              exit 1
            fi
            ;;
          Linux)
            if command -v apt-get >/dev/null 2>&1; then
              sudo apt-get update && sudo apt-get install -y golang-go
            elif command -v yum >/dev/null 2>&1; then
              sudo yum install -y golang
            else
              echo "ERROR: No package manager found. Install from https://go.dev/dl/"
              exit 1
            fi
            ;;
          *)
            echo "ERROR: Unsupported OS. Install Go from https://go.dev/dl/"
            exit 1
            ;;
        esac

        # Verify installation
        if command -v go >/dev/null 2>&1; then
          echo "OK: go $(go version | cut -d' ' -f3) installed"
        else
          echo "ERROR: Go installation failed"
          exit 1
        fi

  check:validate:
    desc: Smoke test lanip module works
    cmds:
      - |
        echo "Validating lanip module..."
        LAN_IP=$(go run ./cmd/lanip 2>&1)
        if [ $? -ne 0 ]; then
          echo "lanip:check:validate FAILED: $LAN_IP"
          exit 1
        fi
        echo "LAN IP: $LAN_IP"
        echo "lanip:check:validate passed"

  check:health:
    desc: Check network connectivity (can reach external DNS)
    cmds:
      - |
        echo "Checking network health..."
        LAN_IP=$(go run ./cmd/lanip 2>&1)
        if [ $? -ne 0 ] || [ -z "$LAN_IP" ]; then
          echo "lanip:check:health FAILED: No LAN IP detected"
          exit 1
        fi
        echo "LAN IP: $LAN_IP"
        echo "lanip:check:health passed"

  # ===========================================================================
  # Tasks
  # ===========================================================================

  get:
    desc: Get LAN IP address
    cmds:
      - go run ./cmd/lanip
