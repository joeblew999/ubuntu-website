# Test workflow for dummy tool round-trip
# Uses 3-platform matrix, but xplat is smart about what to build:
# - CGO=0: Linux builds ALL platforms, macOS/Windows skip
# - CGO=1: Each platform builds its own binaries
#
# This pattern allows ONE workflow for ALL tools
#
name: "Test: Dummy Round-Trip"

on:
  workflow_dispatch:
  push:
    paths:
      - 'cmd/dummy/**'
      - 'cmd/xplat/**'
      - 'taskfiles/Taskfile.dummy.yml'
      - 'taskfiles/toolchain/Taskfile.golang.yml'
      - '.github/workflows/test-dummy.yml'

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - uses: arduino/setup-task@v2
        with:
          version: 3.x

      # Step 1: Build xplat first (needed by other tasks)
      # Build directly to avoid nested taskfile path issues on Windows
      - name: Build xplat
        shell: bash
        run: |
          mkdir -p ~/.local/bin ~/bin
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            go build -o ~/bin/xplat.exe ./cmd/xplat
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            go build -o ~/.local/bin/xplat ./cmd/xplat
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi
          echo "xplat built successfully"

      # Step 2: Test dummy:build (local dev build)
      - name: Build dummy (current platform)
        run: task dummy:build

      # Step 3: Test release build for current platform
      - name: Release build (current platform)
        run: task dummy:release:build

      # Step 4: Test built binary
      - name: Test built binary
        run: task dummy:release:test

      # Step 5: xplat release build - smart based on CGO and OS
      # CGO=0 on Linux: builds ALL platforms
      # CGO=0 on macOS/Windows: skips (Linux already built)
      # CGO=1 on any OS: builds that OS's platforms
      - name: Cross-compile (xplat smart build)
        run: xplat release build dummy

      # Step 6: Verify binaries (Linux only for CGO=0)
      - name: Verify cross-compile output
        if: runner.os == 'Linux'
        run: |
          echo "Built binaries:"
          ls -la .build/dummy-* || echo "No binaries in .build/"

          # Check all 6 expected binaries exist
          for BINARY in dummy-linux-amd64 dummy-linux-arm64 dummy-darwin-amd64 dummy-darwin-arm64 dummy-windows-amd64.exe dummy-windows-arm64.exe; do
            if [ ! -f ".build/$BINARY" ]; then
              echo "ERROR: Missing .build/$BINARY"
              exit 1
            fi
          done
          echo "OK: All 6 platform binaries built"

      # Step 7: Clean installed dummy, then test check:deps
      - name: Clean and test check:deps
        shell: bash
        run: |
          rm -f ~/.local/bin/dummy 2>/dev/null || true
          rm -f ~/bin/dummy.exe 2>/dev/null || true
          task dummy:check:deps

      # Step 8: Test dummy:run
      - name: Run dummy
        run: task dummy:run

      # Step 9: Verify version output
      - name: Verify output
        shell: bash
        run: |
          OUTPUT=$(task dummy:run 2>&1 | tail -1)
          echo "Output: $OUTPUT"
          if [ "$OUTPUT" != "dev" ]; then
            echo "ERROR: Expected 'dev', got '$OUTPUT'"
            exit 1
          fi
          echo "OK: dummy outputs correct version"
