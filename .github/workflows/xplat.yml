# xplat Cross-Platform Build & Release
#
# Builds the xplat binary for all major platforms and releases
# to GitHub Releases when a tag matching xplat-v* is pushed.
#
# Usage:
#   git tag xplat-v0.1.0
#   git push origin xplat-v0.1.0

name: xplat Release

on:
  push:
    tags: ['xplat-v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v0.1.0)'
        required: true
        default: 'dev'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            ext: ''
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            ext: ''
          - os: macos-latest
            goos: darwin
            goarch: amd64
            ext: ''
          - os: macos-latest
            goos: darwin
            goarch: arm64
            ext: ''
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: '.exe'
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Extract version from tag (xplat-v0.1.0 -> v0.1.0)
            echo "version=${GITHUB_REF_NAME#xplat-}" >> $GITHUB_OUTPUT
          fi

      - name: Build xplat
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: '0'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OUTPUT="xplat-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}"
          go build -ldflags="-s -w -X main.Version=${VERSION}" -o "${OUTPUT}" ./cmd/xplat
          echo "Built ${OUTPUT}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xplat-${{ matrix.goos }}-${{ matrix.goarch }}
          path: xplat-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/xplat-v')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          # Move all artifact files to release directory
          for dir in artifacts/*/; do
            [ -d "$dir" ] && cp "$dir"* release/ 2>/dev/null || true
          done
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
          body: |
            ## xplat - Cross-platform utilities for Taskfile

            Download the binary for your platform and add it to your PATH.

            ### Installation

            ```bash
            # macOS (Apple Silicon)
            curl -sL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/xplat-darwin-arm64 -o /usr/local/bin/xplat
            chmod +x /usr/local/bin/xplat

            # macOS (Intel)
            curl -sL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/xplat-darwin-amd64 -o /usr/local/bin/xplat
            chmod +x /usr/local/bin/xplat

            # Linux (x86_64)
            curl -sL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/xplat-linux-amd64 -o ~/.local/bin/xplat
            chmod +x ~/.local/bin/xplat

            # Linux (ARM64)
            curl -sL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/xplat-linux-arm64 -o ~/.local/bin/xplat
            chmod +x ~/.local/bin/xplat
            ```

            ### Commands

            ```
            # Core (P0)
            xplat version          # Print version
            xplat which <binary>   # Find binary in PATH
            xplat glob <pattern>   # Expand glob pattern (supports **)

            # File Operations (P1)
            xplat rm [-rf] <path>  # Remove files or directories
            xplat mkdir [-p] <dir> # Create directories
            xplat cp [-r] <s> <d>  # Copy files or directories

            # Utilities (P2)
            xplat cat <file>       # Print file contents
            xplat touch <file>     # Create or update file
            xplat env <key> [-d v] # Get environment variable
            ```
