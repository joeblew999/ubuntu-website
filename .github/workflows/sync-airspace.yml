# FAA Airspace Data Sync Workflow
#
# Syncs FAA airspace data from ArcGIS to Cloudflare R2.
# Uses ETag tracking to only download changed files.
#
# Schedule: Weekly on Thursday (aligned with AIRAC cycle midpoint)
# Manual: workflow_dispatch for on-demand sync
#
# R2 Upload requires CLOUDFLARE_API_TOKEN secret with R2 permissions.

name: "[Sync] Airspace Data"

on:
  schedule:
    # Run weekly on Thursday at 06:00 UTC
    # AIRAC cycles are every 28 days; Thursday midweek catches most updates
    - cron: '0 6 * * 4'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force re-download all data'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.45.5
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Install tippecanoe
        run: |
          sudo apt-get update
          sudo apt-get install -y tippecanoe

      - name: Restore sync cache
        uses: actions/cache@v4
        with:
          path: data/airspace/sync_etags.json
          key: airspace-sync-${{ github.run_id }}
          restore-keys: |
            airspace-sync-

      - name: Run pipeline
        id: pipeline
        run: |
          # Single command does: sync → tile (if changed) → manifest
          # Same command used locally: task airspace:pipeline
          if [ "${{ inputs.force }}" = "true" ]; then
            task airspace:pipeline:force
          else
            task airspace:pipeline
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if [ -f "data/airspace/sync_result.json" ]; then
            HAS_CHANGES=$(jq -r '.has_changes' data/airspace/sync_result.json)
            UPDATED=$(jq -r '.updated' data/airspace/sync_result.json)
            echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
            echo "updated_count=$UPDATED" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "updated_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload to R2
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: task r2:airspace:upload

      - name: Skip notification
        if: steps.check_changes.outputs.has_changes != 'true'
        run: echo "No changes detected - pipeline skipped tile/manifest/upload (idempotent)"

      - name: Save sync cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/airspace/sync_etags.json
          key: airspace-sync-${{ github.run_id }}

      - name: Summary
        run: |
          echo "## Airspace Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "data/airspace/sync_result.json" ]; then
            echo "### Sync Result" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat data/airspace/sync_result.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PMTiles Files" >> $GITHUB_STEP_SUMMARY
          if [ -d "static/airspace/tiles" ]; then
            ls -lh static/airspace/tiles/*.pmtiles 2>/dev/null || echo "No PMTiles found"
          fi >> $GITHUB_STEP_SUMMARY
